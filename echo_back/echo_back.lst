     1                                  ; =================================================================
     2                                  ; DENSAN V53 VME board "Echo Back" test ROM
     3                                  ; =================================================================
     4                                  
     5                                  ; ▼▼▼ ROMサイズ設定 (ここを環境に合わせる) ▼▼▼
     6                                  %define ROM_SIZE_1024  0x20000  ; 27C010 (128KB)
     7                                  ; 使用するROMサイズを選択
     8                                  %define ROM_TOTAL     ROM_SIZE_1024
     9                                  ; ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
    10                                  
    11                                  ; ==========================================
    12                                  ; V53 System Register
    13                                  ; ==========================================
    14                                  %define SCTL    0x0FFFE ; システム・コントロール・レジスタ
    15                                  %define OPSEL   0x0FFFD ; 内蔵ペリフェラル選択レジスタ
    16                                  %define OPHA    0x0FFFC ; 内蔵ペリフェラル・リロケーション・レジスタ
    17                                  %define DULA    0x0FFFB ; 
    18                                  %define IULA    0x0FFFA ; 
    19                                  %define TULA    0x0FFF9 ; 
    20                                  %define SULA    0x0FFF8 ; SCUリロケーション・レジスタ 
    21                                  %define WCY4    0x0FFF6 ; 
    22                                  %define WCY3    0x0FFF5 ; 
    23                                  %define WCY2    0x0FFF4 ; 
    24                                  %define WMB1    0x0FFF3 ; 
    25                                  %define RFC     0x0FFF2 ; 
    26                                  %define SBCR    0x0FFF1 ; 
    27                                  %define TCKS    0x0FFF0 ; 
    28                                  %define WAC     0x0FFED ; 
    29                                  %define WCY0    0x0FFEC ; 
    30                                  %define WCY1    0x0FFEB ; 
    31                                  %define WMB0    0x0FFEA ; 
    32                                  %define BRC     0x0FFE9 ; ボー・レート・カウンタ
    33                                  %define BADR    0x0FFE1 ; 
    34                                  %define BSEL    0x0FFE0 ; 
    35                                  %define XAM     0x0FF80 ; 
    36                                  %define PGR     0x0FF00 ; 
    37                                  
    38                                  ; SCUレジスタ (SCUは1260Hに配置）
    39                                  %define SCU_DATA 0x01260 ; 送受データ・レジスタ(R:SRB/W:STB)
    40                                  %define SCU_SST  0x01261 ; ステータス・レジスタ(R:SST)
    41                                  %define SCU_SCM  0x01261 ; コマンドレジスタ(W:SCM)
    42                                  %define SCU_SMD  0x01262 ; シリアルモード設定(W:SMD)
    43                                  %define SCU_SIMK 0x01263 ; シリアル割り込みマスクレジスタ(R/W:SIMK)
    44                                  
    45                                  cpu 186
    46                                  bits 16
    47                                  
    48                                  ; ==========================================
    49                                  ; コードセクション (ROMの先頭付近)
    50                                  ; ==========================================
    51                                  section .text
    52                                  org 0
    53                                  
    54                                  ; -----------------------------------------------------------------
    55                                  ; Entry Point (Offset 0x0000)
    56                                  ; -----------------------------------------------------------------
    57                                  start:
    58 00000000 FA                          cli             ; 割り込み禁止
    59                                  
    60                                      ; ---------------------------------------------
    61                                      ; 1. セグメントレジスタ初期化
    62                                      ; ※CSはJMP命令で設定されるので、DS/ES/SSを設定する
    63                                      ; ---------------------------------------------
    64 00000001 B80000                      mov ax, 0x0000
    65 00000004 8ED8                        mov ds, ax
    66 00000006 8EC0                        mov es, ax
    67 00000008 8ED0                        mov ss, ax
    68 0000000A BC0010                      mov sp, 0x1000
    69                                      
    70                                      ; ---------------------------------------------
    71                                      ; 2. システム・コントロール・レジスタ (SCTL) の設定
    72                                      ; ビット4 (SC) = 1 : 内蔵BRGを使用
    73                                      ; ビット0 (IOAG) = 1 : 8ビット・バウンダリ（連続配置）
    74                                      ; ---------------------------------------------
    75 0000000D BAFEFF                      mov dx, SCTL
    76 00000010 B011                        mov al, 00010001b
    77 00000012 EE                          out dx, al
    78                                  
    79                                      ; ---------------------------------------------
    80                                      ; 3. ボーレートジェネレータ (BRG) の設定
    81                                      ;  38400bps設定 (fx=16MHz, factor=x16)
    82                                      ;  16,000,000/(16×38400) ≈ 26
    83                                      ; ---------------------------------------------
    84 00000013 BAE9FF                      mov dx, BRC
    85 00000016 B01A                        mov al, 26
    86 00000018 EE                          out dx, al
    87                                  
    88                                      ; ---------------------------------------------
    89                                      ; 4. IOアドレスの設定 (0x1260にSCUを配置)
    90                                      ; OPHA (FFFCH) に 12H を設定 (ベースアドレス上位8ビット)
    91                                      ; SULA (FFF8H) に 60H を設定 (SCUのオフセット)
    92                                      ; ---------------------------------------------
    93 00000019 BAFCFF                      mov dx, OPHA
    94 0000001C B012                        mov al, 0x12    ; 上位アドレス
    95 0000001E EE                          out dx, al
    96                                  
    97 0000001F BAF8FF                      mov dx, SULA
    98 00000022 B060                        mov al, 0x60    ; 下位アドレス
    99 00000024 EE                          out dx, al
   100                                      
   101                                      ; ---------------------------------------------
   102                                      ; 5. 内蔵周辺選択レジスタ (OPSEL) でSCUを有効化
   103                                      ; ビット3 (SS) = 1 : SCUの使用を許可
   104                                      ; ---------------------------------------------
   105 00000025 BAFDFF                      mov dx, OPSEL
   106 00000028 B008                        mov al, 00001000b   ; Bit3 (SS): SCUの使用を許可
   107 0000002A EE                          out dx, al
   108                                  
   109                                      ; ---------------------------------------------
   110                                      ; 6. SCU内部レジスタの初期化 (配置した1260Hを使用)
   111                                      ; ---------------------------------------------
   112                                      ; 動作モード設定 SMDレジスタ
   113                                      ; Mode: 非同期, 8bit, パリティなし, 1ストップビット, x16クロック
   114                                      ; 01 00 11 10
   115 0000002B BA6212                      mov dx, SCU_SMD
   116 0000002E B04E                        mov al, 01001110b
   117 00000030 EE                          out dx, al
   118                                  
   119                                      ; コマンド設定  SCMレジスタ
   120                                      ; Cmd: 送受信イネーブル, エラーリセット, DTR/RTSアクティブ
   121                                      ; 00 0 1 0 1 0 1
   122 00000031 BA6112                      mov dx, SCU_SCM
   123 00000034 B015                        mov al, 00010101b   ; RTS/DTR ON, RX/TX Enabl
   124 00000036 EE                          out dx, al
   125                                  
   126                                      ; 割り込みはマスクする  SIMKレジスタ
   127 00000037 BA6312                      mov dx, SCU_SIMK
   128 0000003A B003                        mov al, 00000011b
   129 0000003C EE                          out dx, al
   130                                  
   131                                      ; ---------------------------------------------
   132                                      ; 7. 受信したデータをそのまま送信するループ
   133                                      ; ---------------------------------------------
   134                                  main_loop:
   135 0000003D E80500                      call com_recv
   136 00000040 E80F00                      call com_send
   137 00000043 EBF8                        jmp main_loop
   138                                  
   139                                      ; ---------------------------------------------
   140                                      ; シリアル受信ルーチン
   141                                      ; シリアル受信データをalレジスタに格納。dxは破壊される。
   142                                      ; ---------------------------------------------
   143                                  com_recv:
   144 00000045 BA6112                      mov dx, SCU_SST
   145                                  .wait_rx:
   146 00000048 EC                          in al, dx
   147 00000049 A802                        test al, 00000010b  ; RX Ready?
   148 0000004B 74FB                        jz .wait_rx
   149                                   
   150 0000004D BA6012                      mov dx, SCU_DATA
   151 00000050 EC                          in al, dx
   152 00000051 C3                          ret
   153                                  
   154                                      ; ---------------------------------------------
   155                                      ; シリアル送信ルーチン
   156                                      ; alレジスタの内容をシリアル送信。dx, blは破壊される。
   157                                      ; ---------------------------------------------
   158                                  com_send:
   159                                      ; 送信データを退避
   160 00000052 88C3                        mov bl,al
   161                                  
   162 00000054 BA6112                      mov dx, SCU_SST
   163                                  .wait_tx:
   164 00000057 EC                          in al, dx
   165 00000058 A801                        test al, 00000001b  ; TX Ready?
   166 0000005A 74FB                        jz .wait_tx
   167                                      
   168 0000005C BA6012                      mov dx, SCU_DATA
   169 0000005F 88D8                        mov al, bl
   170 00000061 EE                          out dx, al
   171 00000062 C3                          ret
   172                                  
   173                                  ; -----------------------------------------------------------------
   174                                  ; Padding (空白埋め)
   175                                  ; コードの終わりから、リセットベクタの手前までを0xFFで埋める
   176                                  ; -----------------------------------------------------------------
   177 00000063 FF<rep 1FF8Dh>              times ROM_TOTAL - 16 - ($ - $$) db 0xFF
   178                                  
   179                                  ; -----------------------------------------------------------------
   180                                  ; Reset Vector (Physical Address FFFF0h)
   181                                  ; CPUは電源ON時、ここ(ROMの末尾16バイト地点)を実行する
   182                                  ; -----------------------------------------------------------------
   183                                  reset_vector:
   184                                      ; ROMの先頭(start)へジャンプする
   185                                      ; 1MBit ROMの場合、物理アドレスは E0000h～FFFFFh にマップされる想定
   186                                      ; なので、セグメント E000h, オフセット 0000h へ飛べばよい
   187                                      
   188 0001FFF0 EA000000E0                  jmp 0xE000:0000   ; Far Jump to start of 128KB ROM
   189                                  
   190                                      ; ファイルサイズがぴったりROMサイズになるよう調整
   191 0001FFF5 FF<rep Bh>                  times 16 - ($ - reset_vector) db 0xFF
