     1                                  ; =================================================================
     2                                  ; DENSAN V53 VME board "Hello World" test ROM
     3                                  ; =================================================================
     4                                  
     5                                  ; ▼▼▼ ROMサイズ設定 (ここを環境に合わせる) ▼▼▼
     6                                  %define ROM_SIZE_1024  0x20000  ; 27C010 (128KB)
     7                                  ; 使用するROMサイズを選択
     8                                  %define ROM_TOTAL     ROM_SIZE_1024
     9                                  ; ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
    10                                  
    11                                  ; ==========================================
    12                                  ; V53 System Register
    13                                  ; ==========================================
    14                                  %define SCTL    0x0FFFE ; システム・コントロール・レジスタ
    15                                  %define OPSEL   0x0FFFD ; 内蔵ペリフェラル選択レジスタ
    16                                  %define OPHA    0x0FFFC ; 内蔵ペリフェラル・リロケーション・レジスタ
    17                                  %define DULA    0x0FFFB ; 
    18                                  %define IULA    0x0FFFA ; 
    19                                  %define TULA    0x0FFF9 ; 
    20                                  %define SULA    0x0FFF8 ; SCUリロケーション・レジスタ 
    21                                  %define WCY4    0x0FFF6 ; 
    22                                  %define WCY3    0x0FFF5 ; 
    23                                  %define WCY2    0x0FFF4 ; 
    24                                  %define WMB1    0x0FFF3 ; 
    25                                  %define RFC     0x0FFF2 ; 
    26                                  %define SBCR    0x0FFF1 ; 
    27                                  %define TCKS    0x0FFF0 ; 
    28                                  %define WAC     0x0FFED ; 
    29                                  %define WCY0    0x0FFEC ; 
    30                                  %define WCY1    0x0FFEB ; 
    31                                  %define WMB0    0x0FFEA ; 
    32                                  %define BRC     0x0FFE9 ; ボー・レート・カウンタ
    33                                  %define BADR    0x0FFE1 ; 
    34                                  %define BSEL    0x0FFE0 ; 
    35                                  %define XAM     0x0FF80 ; 
    36                                  %define PGR     0x0FF00 ; 
    37                                  
    38                                  ; SCUレジスタ (SCUは1260Hに配置）
    39                                  %define SCU_DATA 0x01260 ; 送受データ・レジスタ(R:SRB/W:STB)
    40                                  %define SCU_SST  0x01261 ; ステータス・レジスタ(R:SST)
    41                                  %define SCU_SCM  0x01261 ; コマンドレジスタ(W:SCM)
    42                                  %define SCU_SMD  0x01262 ; シリアルモード設定(W:SMD)
    43                                  %define SCU_SIMK 0x01263 ; シリアル割り込みマスクレジスタ(R/W:SIMK)
    44                                  
    45                                  cpu 186
    46                                  bits 16
    47                                  
    48                                  ; ==========================================
    49                                  ; コードセクション (ROMの先頭付近)
    50                                  ; ==========================================
    51                                  section .text
    52                                  org 0
    53                                  
    54                                  ; -----------------------------------------------------------------
    55                                  ; Entry Point (Offset 0x0000)
    56                                  ; -----------------------------------------------------------------
    57                                  start:
    58 00000000 FA                          cli             ; 割り込み禁止
    59                                  
    60                                      ; ---------------------------------------------
    61                                      ; 1. セグメントレジスタ初期化
    62                                      ; ※CSはJMP命令で設定されるので、DS/ES/SSを設定する
    63                                      ; ---------------------------------------------
    64 00000001 B80000                      mov ax, 0x0000
    65 00000004 8ED8                        mov ds, ax
    66                                      ; RAMがあるかわからないのでRAMを使わない
    67                                      ;mov es, ax
    68                                      ;mov ss, ax
    69                                      ;mov sp, 0x8000  ; スタックポインタ (とりあえずRAMの中ほどへ)
    70                                  
    71                                      ; ---------------------------------------------
    72                                      ; 2. システム・コントロール・レジスタ (SCTL) の設定
    73                                      ; ビット4 (SC) = 1 : 内蔵BRGを使用
    74                                      ; ビット0 (IOAG) = 1 : 8ビット・バウンダリ（連続配置）
    75                                      ; ---------------------------------------------
    76 00000006 BAFEFF                      mov dx, SCTL
    77 00000009 B011                        mov al, 00010001b
    78 0000000B EE                          out dx, al
    79                                  
    80                                      ; ---------------------------------------------
    81                                      ; 3. ボーレートジェネレータ (BRG) の設定
    82                                      ;  38400bps設定 (fx=16MHz, factor=x16)
    83                                      ;  16,000,000/(16×38400) ≈ 26
    84                                      ; ---------------------------------------------
    85 0000000C BAE9FF                      mov dx, BRC
    86 0000000F B01A                        mov al, 26
    87 00000011 EE                          out dx, al
    88                                  
    89                                      ; ---------------------------------------------
    90                                      ; 4. IOアドレスの設定 (0x1260にSCUを配置)
    91                                      ; OPHA (FFFCH) に 12H を設定 (ベースアドレス上位8ビット)
    92                                      ; SULA (FFF8H) に 60H を設定 (SCUのオフセット)
    93                                      ; ---------------------------------------------
    94 00000012 BAFCFF                      mov dx, OPHA
    95 00000015 B012                        mov al, 0x12    ; 上位アドレス
    96 00000017 EE                          out dx, al
    97                                  
    98 00000018 BAF8FF                      mov dx, SULA
    99 0000001B B060                        mov al, 0x60    ; 下位アドレス
   100 0000001D EE                          out dx, al
   101                                      
   102                                      ; ---------------------------------------------
   103                                      ; 5. 内蔵周辺選択レジスタ (OPSEL) でSCUを有効化
   104                                      ; ビット3 (SS) = 1 : SCUの使用を許可
   105                                      ; ---------------------------------------------
   106 0000001E BAFDFF                      mov dx, OPSEL
   107 00000021 B008                        mov al, 00001000b   ; Bit3 (SS): SCUの使用を許可
   108 00000023 EE                          out dx, al
   109                                  
   110                                      ; ---------------------------------------------
   111                                      ; 6. SCU内部レジスタの初期化 (配置した1260Hを使用)
   112                                      ; ---------------------------------------------
   113                                      ; 動作モード設定 SMDレジスタ
   114                                      ; Mode: 非同期, 8bit, パリティなし, 1ストップビット, x16クロック
   115                                      ; 01 00 11 10
   116 00000024 BA6212                      mov dx, SCU_SMD
   117 00000027 B04E                        mov al, 01001110b
   118 00000029 EE                          out dx, al
   119                                  
   120                                      ; コマンド設定  SCMレジスタ
   121                                      ; Cmd: 送受信イネーブル, エラーリセット, DTR/RTSアクティブ
   122                                      ; 00 0 1 0 1 0 1
   123 0000002A BA6112                      mov dx, SCU_SCM
   124 0000002D B015                        mov al, 00010101b   ; RTS/DTR ON, RX/TX Enabl
   125 0000002F EE                          out dx, al
   126                                  
   127                                      ; 割り込みはマスクする  SIMKレジスタ
   128 00000030 BA6312                      mov dx, SCU_SIMK
   129 00000033 B003                        mov al, 00000011b
   130 00000035 EE                          out dx, al
   131                                  
   132                                      ; ---------------------------------------------
   133                                      ; 7. 'A' を送信し続けるループ
   134                                      ; ---------------------------------------------
   135                                      ; --- Stackless Main Loop ---
   136                                      ; CALL も PUSH も使わず、ひたすらベタ書きで回す
   137                                  main_loop:
   138 00000036 BA6112                      mov dx, SCU_SST
   139                                  .wait_tx:
   140 00000039 EC                          in al, dx
   141 0000003A A801                        test al, 00000001b  ; TX Ready?
   142 0000003C 74FB                        jz .wait_tx
   143                                      
   144 0000003E BA6012                      mov dx, SCU_DATA
   145 00000041 B041                        mov al, 'A'
   146 00000043 EE                          out dx, al
   147                                      
   148                                      ; 簡易ウェイト (レジスタだけでループ)
   149 00000044 B90000                      mov cx, 0
   150                                  .delay:
   151 00000047 90                          nop
   152 00000048 E2FD                        loop .delay
   153                                      
   154 0000004A EBEA                        jmp main_loop
   155                                  
   156                                  ; -----------------------------------------------------------------
   157                                  ; Padding (空白埋め)
   158                                  ; コードの終わりから、リセットベクタの手前までを0xFFで埋める
   159                                  ; -----------------------------------------------------------------
   160 0000004C FF<rep 1FFA4h>              times ROM_TOTAL - 16 - ($ - $$) db 0xFF
   161                                  
   162                                  ; -----------------------------------------------------------------
   163                                  ; Reset Vector (Physical Address FFFF0h)
   164                                  ; CPUは電源ON時、ここ(ROMの末尾16バイト地点)を実行する
   165                                  ; -----------------------------------------------------------------
   166                                  reset_vector:
   167                                      ; ROMの先頭(start)へジャンプする
   168                                      ; 1MBit ROMの場合、物理アドレスは E0000h～FFFFFh にマップされる想定
   169                                      ; なので、セグメント E000h, オフセット 0000h へ飛べばよい
   170                                      
   171 0001FFF0 EA000000E0                  jmp 0xE000:0000   ; Far Jump to start of 128KB ROM
   172                                  
   173                                      ; ファイルサイズがぴったりROMサイズになるよう調整
   174 0001FFF5 FF<rep Bh>                  times 16 - ($ - reset_vector) db 0xFF
