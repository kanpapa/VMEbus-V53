     1                                  ; =================================================================
     2                                  ; DENSAN V53 VME board "RAM TEST" test ROM
     3                                  ; =================================================================
     4                                  
     5                                  ; ▼▼▼ ROMサイズ設定 (ここを環境に合わせる) ▼▼▼
     6                                  %define ROM_SIZE_1024  0x20000  ; 27C010 (128KB)
     7                                  ; 使用するROMサイズを選択
     8                                  %define ROM_TOTAL     ROM_SIZE_1024
     9                                  ; ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
    10                                  
    11                                  ; ==========================================
    12                                  ; V53 System Register
    13                                  ; ==========================================
    14                                  %define SCTL    0x0FFFE ; システム・コントロール・レジスタ
    15                                  %define OPSEL   0x0FFFD ; 内蔵ペリフェラル選択レジスタ
    16                                  %define OPHA    0x0FFFC ; 内蔵ペリフェラル・リロケーション・レジスタ
    17                                  %define DULA    0x0FFFB ; 
    18                                  %define IULA    0x0FFFA ; 
    19                                  %define TULA    0x0FFF9 ; 
    20                                  %define SULA    0x0FFF8 ; SCUリロケーション・レジスタ 
    21                                  %define WCY4    0x0FFF6 ; 
    22                                  %define WCY3    0x0FFF5 ; 
    23                                  %define WCY2    0x0FFF4 ; 
    24                                  %define WMB1    0x0FFF3 ; 
    25                                  %define RFC     0x0FFF2 ; 
    26                                  %define SBCR    0x0FFF1 ; 
    27                                  %define TCKS    0x0FFF0 ; 
    28                                  %define WAC     0x0FFED ; 
    29                                  %define WCY0    0x0FFEC ; 
    30                                  %define WCY1    0x0FFEB ; 
    31                                  %define WMB0    0x0FFEA ; 
    32                                  %define BRC     0x0FFE9 ; ボー・レート・カウンタ
    33                                  %define BADR    0x0FFE1 ; 
    34                                  %define BSEL    0x0FFE0 ; 
    35                                  %define XAM     0x0FF80 ; 
    36                                  %define PGR     0x0FF00 ; 
    37                                  
    38                                  ; SCUレジスタ (SCUは1260Hに配置）
    39                                  %define SCU_DATA 0x01260 ; 送受データ・レジスタ(R:SRB/W:STB)
    40                                  %define SCU_SST  0x01261 ; ステータス・レジスタ(R:SST)
    41                                  %define SCU_SCM  0x01261 ; コマンドレジスタ(W:SCM)
    42                                  %define SCU_SMD  0x01262 ; シリアルモード設定(W:SMD)
    43                                  %define SCU_SIMK 0x01263 ; シリアル割り込みマスクレジスタ(R/W:SIMK)
    44                                  
    45                                  cpu 186
    46                                  bits 16
    47                                  
    48                                  ; ==========================================
    49                                  ; コードセクション (ROMの先頭付近)
    50                                  ; ==========================================
    51                                  section .text
    52                                  org 0
    53                                  
    54                                  ; -----------------------------------------------------------------
    55                                  ; Entry Point (Offset 0x0000)
    56                                  ; -----------------------------------------------------------------
    57                                  start:
    58 00000000 FA                          cli             ; 割り込み禁止
    59                                  
    60                                      ; ---------------------------------------------
    61                                      ; 1. セグメントレジスタ初期化
    62                                      ; ※CSはJMP命令で設定されるので、DS/ES/SSを設定する
    63                                      ; ---------------------------------------------
    64 00000001 B80000                      mov ax, 0x0000
    65 00000004 8ED8                        mov ds, ax      ; DS (Data Segment) を0000Hに設定し、ここをテスト対象とする
    66 00000006 8EC0                        mov es, ax
    67                                      ;mov ss, ax     ; スタックは使わない
    68                                      ;mov sp, 0
    69                                  
    70                                      ; ---------------------------------------------
    71                                      ; 1.1 リフレッシュ制御
    72                                      ; すべてSRAMなのでリフレッシュ禁止にする
    73                                      ; ---------------------------------------------
    74                                      ; リセット時の値
    75                                      ; リセット時　リフレッシュ許可/禁止：不定
    76                                      ; RFC x0-01000
    77 00000008 BAF2FF                      mov dx, RFC
    78 0000000B B000                        mov al, 0
    79 0000000D EE                          out dx, al
    80                                  
    81                                      ; ---------------------------------------------
    82                                      ; 1.2 メモリウェイト値の設定
    83                                      ; オンボードRAMは35nsなので0Waitで良さそう
    84                                      ; 拡張RAMボードは70nsなので途中1waitの領域も設定
    85                                      ; ROMは70nsなので2waitに、外部I/Oは不明のためとりあえず3waitで
    86                                      ; ---------------------------------------------
    87                                      ; リセット時の値
    88                                      ; WMB0  -111-111  16MBのメモリ空間の上位、下位で8MB
    89                                      ; WMB1  -111-111　1MBメモリ空間の上位、下位で512KB
    90                                      ; WCY0-WCY3 すべて7wait
    91                                      ;
    92 0000000E BAF3FF                      mov dx, WMB1
    93 00000011 B071                        mov al, 01110001b	; L=512KB(Onboard RAM) M=256KB(VME RAM?) H=256KB(Onboard ROM)
    94 00000013 EE                          out dx, al
    95                                  
    96 00000014 BAF4FF                      mov dx, WCY2
    97 00000017 B010                        mov al, 00010000b	; M=1wait L=0wait
    98 00000019 EE                          out dx, al
    99                                  
   100 0000001A BAF5FF                      mov dx, WCY3
   101 0000001D B032                        mov al, 00110010b	; IO=3wait H=2wait
   102 0000001F EE                          out dx, al
   103                                  
   104                                      ; ---------------------------------------------
   105                                      ; 2. システム・コントロール・レジスタ (SCTL) の設定
   106                                      ; ビット4 (SC) = 1 : 内蔵BRGを使用
   107                                      ; ビット0 (IOAG) = 1 : 8ビット・バウンダリ（連続配置）
   108                                      ; ---------------------------------------------
   109 00000020 BAFEFF                      mov dx, SCTL
   110 00000023 B011                        mov al, 00010001b
   111 00000025 EE                          out dx, al
   112                                  
   113                                      ; ---------------------------------------------
   114                                      ; 3. ボーレートジェネレータ (BRG) の設定
   115                                      ;  38400bps設定 (fx=16MHz, factor=x16)
   116                                      ;  16,000,000/(16×38400) ≈ 26
   117                                      ; ---------------------------------------------
   118 00000026 BAE9FF                      mov dx, BRC
   119 00000029 B01A                        mov al, 26
   120 0000002B EE                          out dx, al
   121                                  
   122                                      ; ---------------------------------------------
   123                                      ; 4. IOアドレスの設定 (0x1260にSCUを配置)
   124                                      ; OPHA (FFFCH) に 12H を設定 (ベースアドレス上位8ビット)
   125                                      ; SULA (FFF8H) に 60H を設定 (SCUのオフセット)
   126                                      ; ---------------------------------------------
   127 0000002C BAFCFF                      mov dx, OPHA
   128 0000002F B012                        mov al, 0x12    ; 上位アドレス
   129 00000031 EE                          out dx, al
   130                                  
   131 00000032 BAF8FF                      mov dx, SULA
   132 00000035 B060                        mov al, 0x60    ; 下位アドレス
   133 00000037 EE                          out dx, al
   134                                      
   135                                      ; ---------------------------------------------
   136                                      ; 5. 内蔵周辺選択レジスタ (OPSEL) でSCUを有効化
   137                                      ; ビット3 (SS) = 1 : SCUの使用を許可
   138                                      ; ---------------------------------------------
   139 00000038 BAFDFF                      mov dx, OPSEL
   140 0000003B B008                        mov al, 00001000b   ; Bit3 (SS): SCUの使用を許可
   141 0000003D EE                          out dx, al
   142                                  
   143                                      ; ---------------------------------------------
   144                                      ; 6. SCU内部レジスタの初期化 (配置した1260Hを使用)
   145                                      ; ---------------------------------------------
   146                                      ; 動作モード設定 SMDレジスタ
   147                                      ; Mode: 非同期, 8bit, パリティなし, 1ストップビット, x16クロック
   148                                      ; 01 00 11 10
   149 0000003E BA6212                      mov dx, SCU_SMD
   150 00000041 B04E                        mov al, 01001110b
   151 00000043 EE                          out dx, al
   152                                  
   153                                      ; コマンド設定  SCMレジスタ
   154                                      ; Cmd: 送受信イネーブル, エラーリセット, DTR/RTSアクティブ
   155                                      ; 00 0 1 0 1 0 1
   156 00000044 BA6112                      mov dx, SCU_SCM
   157 00000047 B015                        mov al, 00010101b   ; RTS/DTR ON, RX/TX Enabl
   158 00000049 EE                          out dx, al
   159                                  
   160                                      ; 割り込みはマスクする  SIMKレジスタ
   161 0000004A BA6312                      mov dx, SCU_SIMK
   162 0000004D B003                        mov al, 00000011b
   163 0000004F EE                          out dx, al
   164                                  
   165                                      ; ---------------------------------------------
   166                                      ; 7. メモリ書き込み後に読み出してメモリテストをするループ
   167                                      ; ---------------------------------------------
   168                                      ; --- Stackless Main Loop ---
   169                                      ; CALL も PUSH も使わず、ひたすらベタ書きで回す
   170                                  
   171                                      ; ループカウンタ兼アドレスポインタ (SIを使用)
   172                                      ; SI = 0000H からスタート
   173 00000050 BE0000                      mov si, 0x0000
   174                                  
   175                                  main_loop:
   176                                      ; --- 書き込み ---
   177                                      ; アドレス [DS:SI] にテスト値を書き込む
   178 00000053 C60455                      mov byte [si], 0x55     ; 書き込む値(01010101)
   179                                  
   180                                      ; --- 読み出し ---
   181                                      ; アドレス [DS:SI] から値を読み出す
   182 00000056 8A04                        mov al, byte [si]
   183                                  
   184                                      ; --- 比較 ---
   185 00000058 3C55                        cmp al, 0x55
   186 0000005A 7532                        jne error_found_55         ; 一致しない場合はエラー処理へ
   187                                  
   188                                      ; 同様に0xAA(10101010)でも確認
   189 0000005C C604AA                      mov byte [si], 0xAA
   190 0000005F 8A04                        mov al, byte [si]
   191 00000061 3CAA                        cmp al, 0xAA
   192 00000063 752D                        jne error_found_AA
   193                                  
   194                                      ; メモリをクリアして次へ
   195 00000065 C60400                      mov byte [si], 0x00
   196                                  
   197                                  next_addr:
   198                                      ; --- アドレス更新 ---
   199 00000068 46                          inc si                 ; アドレスをインクリメント
   200 00000069 83FE00                      cmp si, 0000H           ; 0000Hに戻ったかチェック (FFFFHの次は0000H)
   201 0000006C 7402                        je  segment_update      ; SIが0になったら次のセグメントへ
   202 0000006E EBE3                        jmp main_loop           ; 0でなければループ継続
   203                                  
   204                                  segment_update:
   205                                      ; --- セグメント更新 ---
   206 00000070 8CD8                        mov ax, ds
   207 00000072 050010                      add ax, 1000h
   208 00000075 8ED8                        mov ds, ax
   209                                  
   210                                      ; --- 終了判定（E0000-FFFFFはROMエリアのため省く）---
   211 00000077 3D00E0                      cmp ax, 0e000h
   212 0000007A 7402                        je all_done
   213                                  
   214 0000007C EBD5                        jmp main_loop
   215                                  
   216                                  all_done:
   217                                      ; --- 終了処理 (全チェック完了) ---
   218                                      ; シリアル送信部
   219 0000007E BA6112                      mov dx, SCU_SST
   220                                  .wait_tx3:
   221 00000081 EC                          in al, dx
   222 00000082 A801                        test al, 00000001b  ; TX Ready?
   223 00000084 74FB                        jz .wait_tx3
   224                                      
   225 00000086 BA6012                      mov dx, SCU_DATA
   226 00000089 B023                        mov al, '#'         ; 終了したことを示す表示
   227 0000008B EE                          out dx, al
   228                                  
   229                                      ;無限ループで停止
   230 0000008C EBFE                        jmp $
   231                                  ; -------------------------------------------------------------
   232                                  ; エラー分岐用フック
   233                                  ; -------------------------------------------------------------
   234                                  error_found_55:
   235                                      ; ALには読み出した「間違った値」が入っている
   236 0000008E 88C7                        mov bh, al          ; BHに読み出し値を保存 (BLは文字出力で使うのでBHを使う)
   237 00000090 EB04                        jmp error_found_main
   238                                  
   239                                  error_found_AA:
   240 00000092 88C7                        mov bh, al          ; BHに読み出し値を保存
   241 00000094 EB00                        jmp error_found_main
   242                                  
   243                                  ; -------------------------------------------------------------
   244                                  ; エラー表示ルーチン
   245                                  ; 出力形式: SSSS OOOO VV (Segment Offset Value)
   246                                  ; -------------------------------------------------------------
   247                                  error_found_main:
   248                                      ; 状態フラグ(BX)を使って、セグメント表示とオフセット表示で
   249                                      ; 同じ処理(PRINT_HEX)を使い回す。
   250                                      ; レジスタ競合回避のため、DIをフラグとして使用
   251                                      ; DI = 2 : セグメント表示 (4桁)
   252                                      ; DI = 1 : オフセット表示 (4桁)
   253                                      ; DI = 0 : 読み出し値表示 (2桁)
   254                                  
   255 00000096 BF0200                      mov di, 2   
   256                                  
   257                                  setup_print_phase:
   258                                      ; フェーズに応じた準備
   259 00000099 83FF02                      cmp di, 2       ; セグメント(DS)を表示
   260 0000009C 7407                        je phase_segment
   261 0000009E 83FF01                      cmp di, 1
   262 000000A1 7409                        je phase_offset
   263 000000A3 EB0E                        jmp phase_value
   264                                  
   265                                  phase_segment:
   266 000000A5 8CDD                        mov bp, ds              ; 表示データ: DS
   267 000000A7 B90400                      mov cx, 4               ; 4桁分ループ (4 nibbles)
   268 000000AA EB12                        jmp print_hex_start
   269                                  
   270                                  phase_offset:
   271 000000AC 89F5                        mov bp, si          ; 表示データ: SI
   272 000000AE B90400                      mov cx, 4           ; 4桁
   273 000000B1 EB0B                        jmp print_hex_start
   274                                  
   275                                  phase_value:
   276                                      ; BHに入っている8bit値を表示
   277 000000B3 88F8                        mov al, bh
   278 000000B5 B400                        mov ah, 0           ; AX = 00xxh
   279 000000B7 89C5                        mov bp, ax          ; 表示データ: AX
   280 000000B9 B90200                      mov cx, 2           ; 8bitなので2桁でOK
   281 000000BC EB00                        jmp print_hex_start
   282                                  
   283                                  print_hex_start:
   284                                      ; --- 16進数出力ループ ---
   285                                  print_hex_loop:
   286                                      ; 上位4ビットを取り出すために左ローテート
   287 000000BE D1C5                        rol bp, 1
   288 000000C0 D1C5                        rol bp, 1
   289 000000C2 D1C5                        rol bp, 1
   290 000000C4 D1C5                        rol bp, 1
   291                                      
   292 000000C6 89E8                        mov ax, bp              ; AXにコピー
   293 000000C8 83E00F                      and ax, 000fh           ; 下位4ビットのみ抽出 (0-F)
   294                                  
   295                                      ; HEX ASCII変換
   296 000000CB 3C0A                        cmp al, 0ah
   297 000000CD 7202                        jb  is_digit
   298 000000CF 0407                        add al, 07h             ; 'A'-'F' の場合の調整
   299                                  is_digit:
   300 000000D1 0430                        add al, 30h             ; '0' のASCIIコードを足す
   301                                  
   302                                      ; --- 文字送信 (SCU) ---
   303                                      ; レジスタ退避ができないため、他のレジスタを壊さないよう注意
   304                                      ; ここでは AH を作業用、AL を送信データとして使用
   305                                      
   306 000000D3 88C3                        mov bl, al              ; 送信文字をBLに一時退避
   307                                  
   308                                      ; シリアル送信部
   309 000000D5 BA6112                      mov dx, SCU_SST
   310                                  .wait_tx:
   311 000000D8 EC                          in al, dx
   312 000000D9 A801                        test al, 00000001b  ; TX Ready?
   313 000000DB 74FB                        jz .wait_tx
   314                                      
   315 000000DD BA6012                      mov dx, SCU_DATA
   316 000000E0 88D8                        mov al, bl
   317 000000E2 EE                          out dx, al
   318                                  
   319 000000E3 E2D9                        loop print_hex_loop     ; CXを減らしてループ
   320                                  
   321                                      ; --- 16進数表示完了後の処理 ---
   322                                      ; 読みやすくするため16進数の後にスペースをいれる
   323                                      ; シリアル送信部
   324 000000E5 BA6112                      mov dx, SCU_SST
   325                                  .wait_tx2:
   326 000000E8 EC                          in al, dx
   327 000000E9 A801                        test al, 00000001b  ; TX Ready?
   328 000000EB 74FB                        jz .wait_tx2
   329                                      
   330 000000ED BA6012                      mov dx, SCU_DATA
   331 000000F0 B020                        mov al, ' '
   332 000000F2 EE                          out dx, al
   333                                  
   334                                      ; --- 次のフェーズへ遷移 ---
   335 000000F3 4F                          dec di              ; 2->1->0->(-1)
   336 000000F4 83FFFF                      cmp di, -1
   337 000000F7 7402                        je error_done       ; 0(値)まで表示し終わったら完了
   338                                  
   339 000000F9 EB9E                        jmp setup_print_phase
   340                                  
   341                                  error_done:
   342                                      ; --- テスト継続 ---
   343 000000FB E96AFF                      jmp next_addr
   344                                  
   345                                  ; -----------------------------------------------------------------
   346                                  ; Padding (空白埋め)
   347                                  ; コードの終わりから、リセットベクタの手前までを0xFFで埋める
   348                                  ; -----------------------------------------------------------------
   349 000000FE FF<rep 1FEF2h>              times ROM_TOTAL - 16 - ($ - $$) db 0xFF
   350                                  
   351                                  ; -----------------------------------------------------------------
   352                                  ; Reset Vector (Physical Address FFFF0h)
   353                                  ; CPUは電源ON時、ここ(ROMの末尾16バイト地点)を実行する
   354                                  ; -----------------------------------------------------------------
   355                                  reset_vector:
   356                                      ; ROMの先頭(start)へジャンプする
   357                                      ; 1MBit ROMの場合、物理アドレスは E0000h～FFFFFh にマップされる想定
   358                                      ; なので、セグメント E000h, オフセット 0000h へ飛べばよい
   359                                      
   360 0001FFF0 EA000000E0                  jmp 0xE000:0000   ; Far Jump to start of 128KB ROM
   361                                  
   362                                      ; ファイルサイズがぴったりROMサイズになるよう調整
   363 0001FFF5 FF<rep Bh>                  times 16 - ($ - reset_vector) db 0xFF
