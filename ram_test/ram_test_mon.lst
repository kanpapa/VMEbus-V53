     1                                  ; =================================================================
     2                                  ; V53 Memory Test v2 for V53 MONITOR
     3                                  ; =================================================================
     4                                      cpu 186
     5                                      bits 16
     6                                      
     7                                  section .text
     8                                      org 0
     9                                  
    10                                      ; --- 設定 ---
    11                                      %define SCU_DATA    0x01260
    12                                      %define SCU_SST     0x01261
    13                                      %define TX_READY    0x01
    14                                      
    15                                      ; テスト対象アドレス
    16                                      %define TEST_SEG    0x3000 
    17                                  
    18                                      ; モニタの再起動アドレス (ROMの先頭)
    19                                      %define MON_BOOT    0xE000:0000
    20                                  
    21                                  entry:
    22                                      ; --- 初期化 ---
    23 00000000 1E                          push ds
    24 00000001 06                          push es
    25 00000002 8CC8                        mov ax, cs
    26 00000004 8ED8                        mov ds, ax
    27                                  
    28 00000006 BE[DC00]                    mov si, msg_start
    29 00000009 E87C00                      call puts
    30                                  
    31                                      ; --- テスト準備 ---
    32 0000000C B80030                      mov ax, TEST_SEG
    33 0000000F 8EC0                        mov es, ax
    34 00000011 31FF                        xor di, di
    35                                  
    36                                      ; --- パターン 0x55 ---
    37                                  test_55:
    38 00000013 B055                        mov al, 0x55
    39 00000015 E81100                      call run_test_byte
    40 00000018 7232                        jc error_found
    41                                  
    42                                      ; --- パターン 0xAA ---
    43                                  test_aa:
    44 0000001A B0AA                        mov al, 0xAA
    45 0000001C E80A00                      call run_test_byte
    46 0000001F 722B                        jc error_found
    47                                  
    48                                      ; --- 成功 ---
    49 00000021 BE[E700]                    mov si, msg_pass
    50 00000024 E86100                      call puts
    51 00000027 EB58                        jmp exit_prog
    52                                  
    53                                  ; -----------------------------------------------------------------
    54                                  ; Subroutine: 指定パターンの書き込み・検証
    55                                  ; -----------------------------------------------------------------
    56                                  run_test_byte:
    57 00000029 B90000                      mov cx, 0       ; Loop 64KB
    58 0000002C 31FF                        xor di, di      ; Reset Offset
    59                                  
    60                                  .write_loop:
    61 0000002E 268805                      mov [es:di], al ; 書き込み
    62 00000031 47                          inc di
    63 00000032 E2FA                        loop .write_loop
    64                                  
    65                                      ; 検証フェーズ
    66 00000034 B90000                      mov cx, 0
    67 00000037 31FF                        xor di, di
    68                                      
    69                                      ; dotを出力
    70 00000039 50                          push ax
    71 0000003A E85800                      call put_dot
    72 0000003D 58                          pop ax
    73                                      
    74                                  .verify_loop:
    75 0000003E 268A1D                      mov bl, [es:di] ; 読み出し
    76 00000041 38C3                        cmp bl, al      ; AL(0x55) と比較
    77 00000043 7505                        jne .verify_err ; 不一致ならエラーへ
    78                                  
    79 00000045 47                          inc di
    80 00000046 E2F6                        loop .verify_loop
    81                                  
    82 00000048 F8                          clc             ; CF=0 Success
    83 00000049 C3                          ret
    84                                  
    85                                  .verify_err:
    86 0000004A F9                          stc             ; CF=1 Error
    87 0000004B C3                          ret
    88                                  
    89                                  ; エラー表示ルーチン
    90                                  error_found:
    91 0000004C 50                          push ax
    92 0000004D 53                          push bx
    93 0000004E E85D00                      call putc_crlf
    94                                      
    95 00000051 BE[F000]                    mov si, msg_err     ; エラー表示
    96 00000054 E83100                      call puts
    97                                      
    98 00000057 8CC0                        mov ax, es          ; esを16進数で表示
    99 00000059 E85B00                      call print_hex_word
   100                                      
   101 0000005C B03A                        mov al, ':'         ; セパレーターを表示
   102 0000005E E83A00                      call putc
   103                                      
   104 00000061 89F8                        mov ax, di          ; diを表示
   105 00000063 E85100                      call print_hex_word
   106                                      
   107 00000066 BE[F500]                    mov si, msg_write   ; W: を表示
   108 00000069 E81C00                      call puts
   109                                      
   110 0000006C 5B                          pop bx
   111 0000006D 58                          pop ax
   112 0000006E 53                          push bx
   113 0000006F E84C00                      call print_hex_byte ; 書き込んだデータを表示
   114                                      
   115 00000072 BE[F900]                    mov si, msg_read    ; R: を表示
   116 00000075 E81000                      call puts
   117                                      
   118 00000078 5B                          pop bx
   119 00000079 88D8                        mov al, bl
   120 0000007B E84000                      call print_hex_byte ; 読みだしたデータを表示
   121 0000007E E82D00                      call putc_crlf
   122                                      ; fall through to exit
   123                                  
   124                                  exit_prog:
   125 00000081 07                          pop es
   126 00000082 1F                          pop ds
   127                                  
   128                                      ; モニタへ戻るためのジャンプ
   129 00000083 EA000000E0                  jmp MON_BOOT
   130                                  
   131                                  ; --- Utilities ---
   132                                  puts:
   133 00000088 8A04                        mov al, [si]
   134 0000008A 08C0                        or al, al
   135 0000008C 7406                        jz .ret
   136 0000008E E80A00                      call putc
   137 00000091 46                          inc si
   138 00000092 EBF4                        jmp puts
   139 00000094 C3                      .ret: ret
   140                                  
   141                                  put_dot:
   142 00000095 B02E                        mov al, '.'
   143 00000097 E80100                      call putc
   144 0000009A C3                          ret
   145                                  
   146                                  putc:
   147 0000009B 52                          push dx
   148 0000009C 50                          push ax
   149 0000009D BA6112                      mov dx, SCU_SST
   150 000000A0 EC                      .w: in al, dx
   151 000000A1 A801                        test al, TX_READY
   152 000000A3 74FB                        jz .w
   153 000000A5 BA6012                      mov dx, SCU_DATA
   154 000000A8 58                          pop ax
   155 000000A9 50                          push ax
   156 000000AA EE                          out dx, al
   157 000000AB 58                          pop ax
   158 000000AC 5A                          pop dx
   159 000000AD C3                          ret
   160                                  
   161                                  putc_crlf:
   162 000000AE B00D                        mov al, 0x0D
   163 000000B0 E8E8FF                      call putc
   164 000000B3 B00A                        mov al, 0x0A
   165 000000B5 EBE4                        jmp putc
   166                                  
   167                                  print_hex_word:
   168 000000B7 50                          push ax
   169 000000B8 88E0                        mov al, ah
   170 000000BA E80100                      call print_hex_byte
   171 000000BD 58                          pop ax
   172                                  print_hex_byte:
   173 000000BE 50                          push ax
   174 000000BF 51                          push cx
   175 000000C0 50                          push ax
   176 000000C1 C0E804                      shr al, 4
   177 000000C4 E80900                      call .digit
   178 000000C7 58                          pop ax
   179 000000C8 240F                        and al, 0x0F
   180 000000CA E80300                      call .digit
   181 000000CD 59                          pop cx
   182 000000CE 58                          pop ax
   183 000000CF C3                          ret
   184                                  .digit:
   185 000000D0 0430                        add al, '0'
   186 000000D2 3C39                        cmp al, '9'
   187 000000D4 7602                        jbe .p
   188 000000D6 0407                        add al, 7
   189 000000D8 E8C0FF                  .p: call putc
   190 000000DB C3                          ret
   191                                  
   192                                  ; --- Data ---
   193 000000DC 4D656D546573742E2E-     msg_start: db "MemTest...", 0
   193 000000E5 2E00               
   194 000000E7 2050617373210D0A00      msg_pass:  db " Pass!", 0x0D, 0x0A, 0
   195 000000F0 4572722000              msg_err:   db "Err ", 0
   196 000000F5 20573A00                msg_write: db " W:", 0
   197 000000F9 20523A00                msg_read:  db " R:", 0
