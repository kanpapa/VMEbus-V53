     1                                  ; =================================================================
     2                                  ; V53 Monitor System v0.5  2026-01-24
     3                                  ; Target: V53 VME Board & DOSBox-X Simulation
     4                                  ; =================================================================
     5                                  
     6                                  ; --- ビルド方法 ---
     7                                  ; DOSBox: nasm -f bin -dSIM v53_ram_mon.asm -o v53_ram_mon.com -l v53_ram_mon.lst
     8                                  ; Real:   nasm -f bin v53_ram_mon.asm -o v53_ram_mon.bin -l v53_ram_mon.lst
     9                                  ; -----------------
    10                                  
    11                                  ; ==========================================
    12                                  ; V53 System Register
    13                                  ; ==========================================
    14                                  %define SCTL    0x0FFFE ; システム・コントロール・レジスタ
    15                                  %define OPSEL   0x0FFFD ; 内蔵ペリフェラル選択レジスタ
    16                                  %define OPHA    0x0FFFC ; 内蔵ペリフェラル・リロケーション・レジスタ
    17                                  %define DULA    0x0FFFB ; 
    18                                  %define IULA    0x0FFFA ; 
    19                                  %define TULA    0x0FFF9 ; TCUリロケーション・レジスタ
    20                                  %define SULA    0x0FFF8 ; SCUリロケーション・レジスタ 
    21                                  %define WCY4    0x0FFF6 ; プログラマブル・ウェイト・サイクル数設定レジスタ4
    22                                  %define WCY3    0x0FFF5 ; プログラマブル・ウェイト・サイクル数設定レジスタ3
    23                                  %define WCY2    0x0FFF4 ; プログラマブル・ウェイト・サイクル数設定レジスタ2
    24                                  %define WMB1    0x0FFF3 ; プログラマブル・ウェイト・メモリ領域設定レジスタ1
    25                                  %define RFC     0x0FFF2 ; リフレッシュ・コントロール・レジスタ
    26                                  %define SBCR    0x0FFF1 ; 
    27                                  %define TCKS    0x0FFF0 ; タイマー・クロック選択レジスタ
    28                                  %define WAC     0x0FFED ; プログラマブル・ウェイト・メモリ・アドレス・コントロール・レジスタ
    29                                  %define WCY0    0x0FFEC ; プログラマブル・ウェイト・サイクル数設定レジスタ0
    30                                  %define WCY1    0x0FFEB ; プログラマブル・ウェイト・サイクル数設定レジスタ1
    31                                  %define WMB0    0x0FFEA ; プログラマブル・ウェイト・メモリ領域設定レジスタ0
    32                                  %define BRC     0x0FFE9 ; ボー・レート・カウンタ
    33                                  %define BADR    0x0FFE1 ; 
    34                                  %define BSEL    0x0FFE0 ; 
    35                                  %define XAM     0x0FF80 ; 
    36                                  %define PGR     0x0FF00 ; 
    37                                  
    38                                  
    39                                  
    40                                  %ifdef SIM
    41                                      ; --- Simulation Mode ---
    42                                      org 0x100
    43                                      cpu 186
    44                                  
    45                                      %define SCU_DATA   0x3F8
    46                                      %define SCU_SST    0x3FD
    47                                      %define TX_READY    0x20                                 
    48                                      %define RX_READY    0x01
    49                                  %else
    50                                      ; --- Real Hardware Mode ---
    51                                      org 0
    52                                      cpu 186
    53                                  
    54                                      ; SCUレジスタ (SCUは1260Hに配置）
    55                                      %define SCU_DATA    0x01260 ; 送受データ・レジスタ(R:SRB/W:STB)
    56                                      %define SCU_SST     0x01261 ; ステータス・レジスタ(R:SST)
    57                                      %define SCU_SCM     0x01261 ; コマンドレジスタ(W:SCM)
    58                                      %define SCU_SMD     0x01262 ; シリアルモード設定(W:SMD)
    59                                      %define SCU_SIMK    0x01263 ; シリアル割り込みマスクレジスタ(R/W:SIMK)
    60                                      %define TX_READY    00000001b   ; TBRDY                                 
    61                                      %define RX_READY    00000010b   ; RBRDY
    62                                  
    63                                      ; --- タイマーレジスタ (TCUは1270Hに配置) ---
    64                                      %define TM0_CNT     0x01270 ; Timer 0 Counter
    65                                      %define TM1_CNT     0x01271 ; Timer 1 Counter
    66                                      %define TM2_CNT     0x01272 ; Timer 2 Counter
    67                                      %define TM_CTL      0x01273 ; Timer Control
    68                                  
    69                                      %define DIV_LOW     0x04 ; 分周比 4 (1.2288MHz -> 307.2kHz)
    70                                      %define DIV_HIGH    0x00
    71                                  %endif
    72                                  
    73                                  section .text
    74                                  
    75                                  start:
    76                                  %ifdef SIM
    77                                      xor ax, ax
    78                                      mov es, ax
    79                                  %else
    80 00000000 FA                          cli
    81                                  
    82                                      ; ---------------------------------------------
    83                                      ; 1. セグメントレジスタ初期化
    84                                      ; CS=DS=ES を想定
    85                                      ; ---------------------------------------------
    86 00000001 0E                          push cs
    87 00000002 1F                          pop ds
    88 00000003 0E                          push cs
    89 00000004 07                          pop es
    90                                      ; スタックは簡易モニタのものをそのまま使う
    91                                  
    92                                      ;------------------------------------------
    93                                      ; TCUの追加設定
    94                                      ;------------------------------------------
    95                                      ; 1. 内蔵周辺機能の有効化 (OPSEL)
    96                                      ;------------------------------------------
    97 00000005 BAFDFF                      mov  dx, OPSEL
    98 00000008 EC                          in   al, dx
    99 00000009 0C04                        or   al, 00000100b   ; Bit 2 (TCU) をセット
   100 0000000B EE                          out  dx, al
   101                                  
   102                                      ;------------------------------------------
   103                                      ; 2. レジスタ配置アドレスの設定 (TULA)
   104                                      ;------------------------------------------
   105 0000000C BAF9FF                      mov dx, TULA
   106 0000000F B070                        mov al, 0x70    ; 下位アドレス
   107 00000011 EE                          out dx, al
   108                                  
   109                                      ;------------------------------------------
   110                                      ; 3. TCKS: タイマクロック入力選択
   111                                      ;------------------------------------------
   112 00000012 BAF0FF                      mov  dx, TCKS
   113 00000015 B01C                        mov  al, 00011100b   ; Timer1: TCLK端子入力使用
   114 00000017 EE                          out  dx, al
   115                                  
   116                                      ;------------------------------------------
   117                                      ; 3. タイマー初期化 (Mode 3 / Square Wave)
   118                                      ;------------------------------------------
   119 00000018 BA7312                      mov  dx, TM_CTL
   120                                  
   121                                      ; --- Timer 0 Setup ---
   122 0000001B B036                        mov  al, 0x36         ; Mode 3, Binary, LSB/MSB
   123 0000001D EE                          out  dx, al
   124                                      
   125                                      ; --- Timer 1 Setup ---
   126 0000001E B076                        mov  al, 0x76         ; Mode 3, Binary, LSB/MSB
   127 00000020 EE                          out  dx, al
   128                                  
   129                                      ; --- Timer 2 Setup ---
   130 00000021 B0B6                        mov  al, 0xb6         ; Mode 3, Binary, LSB/MSB
   131 00000023 EE                          out  dx, al
   132                                  
   133                                      ;------------------------------------------
   134                                      ; 4. カウンタ値 (分周比) のロード
   135                                      ;------------------------------------------
   136                                      ; Timer 0
   137 00000024 BA7012                      mov  dx, TM0_CNT
   138 00000027 B004                        mov  al, DIV_LOW
   139 00000029 EE                          out  dx, al
   140 0000002A B000                        mov  al, DIV_HIGH
   141 0000002C EE                          out  dx, al
   142                                  
   143                                      ; Timer 1
   144 0000002D BA7112                      mov  dx, TM1_CNT
   145 00000030 B004                        mov  al, DIV_LOW
   146 00000032 EE                          out  dx, al
   147 00000033 B000                        mov  al, DIV_HIGH
   148 00000035 EE                          out  dx, al
   149                                  
   150                                          ; Timer 2
   151 00000036 BA7212                      mov  dx, TM2_CNT
   152 00000039 B004                        mov  al, DIV_LOW
   153 0000003B EE                          out  dx, al
   154 0000003C B000                        mov  al, DIV_HIGH
   155 0000003E EE                          out  dx, al
   156                                  %endif
   157                                  
   158                                      ; 変数初期化 (RAMエリアをクリア)
   159 0000003F C706[C304]0000              mov word [dump_seg], 0x0000
   160 00000045 C706[C504]0000              mov word [dump_off], 0x0000
   161 0000004B C706[C704]0020              mov word [load_seg], 0x2000
   162                                  
   163                                      ; スタートメッセージの表示
   164 00000051 BE[A603]                    mov si, msg_boot
   165 00000054 E89502                      call puts
   166                                  
   167                                  ; =================================================================
   168                                  ; Main Loop
   169                                  ; =================================================================
   170                                  monitor_loop:
   171 00000057 B03E                        mov al, '>'
   172 00000059 E89E02                      call putc
   173 0000005C B020                        mov al, ' '
   174 0000005E E89902                      call putc
   175                                  
   176 00000061 E8B802                      call getc_echo  ; コマンド受信（エコーあり）
   177 00000064 88C3                        mov bl, al
   178                                      
   179 00000066 80FB64                      cmp bl, 'd'     ; dump command
   180 00000069 746B                        je do_dump
   181 0000006B 80FB44                      cmp bl, 'D'
   182 0000006E 7466                        je do_dump
   183                                      
   184 00000070 80FB6C                      cmp bl, 'l'     ; load command
   185 00000073 7503E9C100                  je do_load
   186 00000078 80FB4C                      cmp bl, 'L'
   187 0000007B 7503E9B900                  je do_load
   188                                      
   189 00000080 80FB67                      cmp bl, 'g'     ; go command
   190 00000083 7503E92C01                  je do_go
   191 00000088 80FB47                      cmp bl, 'G'
   192 0000008B 7503E92401                  je do_go
   193                                  
   194 00000090 80FB77                      cmp bl, 'w'     ; Write command
   195 00000093 7503E94801                  je do_write
   196 00000098 80FB57                      cmp bl, 'W'
   197 0000009B 7503E94001                  je do_write
   198                                  
   199 000000A0 3C69                        cmp al, 'i'     ; Input Port command
   200 000000A2 7503E97C01                  je do_in
   201 000000A7 3C49                        cmp al, 'I'
   202 000000A9 7503E97501                  je do_in
   203                                  
   204 000000AE 3C6F                        cmp al, 'o'     ; Output Port command
   205 000000B0 7503E99201                  je do_out
   206 000000B5 3C4F                        cmp al, 'O'
   207 000000B7 7503E98B01                  je do_out
   208                                  
   209 000000BC 3C73                        cmp al, 's'     ; Scan I/O command
   210 000000BE 7503E9AB01                  je do_scan
   211 000000C3 3C53                        cmp al, 'S'
   212 000000C5 7503E9A401                  je do_scan
   213                                      
   214 000000CA 3C3F                        cmp al, '?'     ; Help
   215 000000CC 7503E90F02                  je cmd_help
   216                                  
   217                                      ; 知らないコマンドなら改行して戻る
   218 000000D1 E85102                      call putc_crlf
   219 000000D4 EB81                        jmp monitor_loop
   220                                  
   221                                  ; =================================================================
   222                                  ; Command: Dump Memory
   223                                  ; Usage:
   224                                  ;   D               -> Dump next 64 bytes
   225                                  ;   D <Seg> <Off>   -> Set address and dump (e.g., D 0000 8000)
   226                                  ; =================================================================
   227                                  do_dump:
   228 000000D6 E84302                      call getc_echo      ; 区切り文字受信 (Space or Enter)
   229 000000D9 3C0D                        cmp al, 0x0D        ; Enterならすぐ実行
   230 000000DB 7418                        je .dump_run
   231 000000DD 3C20                        cmp al, ' '         ; Spaceなら引数解析
   232 000000DF 7405                        je .parse_args
   233                                      
   234                                      ; それ以外なら無視して実行へ（またはエラー処理）
   235 000000E1 E84102                      call putc_crlf
   236 000000E4 EB12                        jmp .dump_run_start
   237                                  
   238                                  .parse_args:
   239 000000E6 E86A02                      call get_hex_word
   240 000000E9 A3[C304]                    mov [dump_seg], ax
   241 000000EC E8AA02                      call skip_space
   242 000000EF E86102                      call get_hex_word
   243 000000F2 A3[C504]                    mov [dump_off], ax
   244                                      ; ここでEnter待ちをするか、そのまま実行するか
   245                                      ; 今回はパラメータ入力後にEnterを押したと仮定して改行
   246                                      
   247                                  .dump_run:
   248 000000F5 E82D02                      call putc_crlf              ; 実行直前に改行
   249                                  
   250                                  .dump_run_start:
   251 000000F8 B90400                      mov cx, 4                   ; 4行表示する
   252                                      
   253                                  .line_loop:
   254 000000FB 51                          push cx
   255                                      
   256 000000FC A1[C304]                    mov ax, [dump_seg]          ; セグメントの表示
   257 000000FF E82C02                      call print_hex_word
   258 00000102 B03A                        mov al, ':'                 ; 区切り文字の:を表示
   259 00000104 E8F301                      call putc
   260 00000107 A1[C504]                    mov ax, [dump_off]          ; オフセットの表示
   261 0000010A E82102                      call print_hex_word
   262 0000010D B020                        mov al, ' '                 ; 区切り文字のスペースを表示
   263 0000010F E8E801                      call putc
   264                                  
   265 00000112 8B36[C504]                  mov si, [dump_off]          ; DS変更前に、モニタ変数からオフセットをSIにロード
   266                                  
   267 00000116 1E                          push ds                     ; モニタのDSを保存
   268 00000117 8E1E[C304]                  mov ds, [dump_seg]          ; DSをターゲットセグメントに変更
   269                                      
   270 0000011B B91000                      mov cx, 16                  ; 16回繰り返すカウンタ
   271                                  .hex_loop:
   272 0000011E 8A04                        mov al, [si]
   273 00000120 E81202                      call print_hex_byte         ; メモリ内容の表示
   274 00000123 B020                        mov al, ' '                 ; 区切り文字のスペースを表示
   275 00000125 E8D201                      call putc
   276 00000128 46                          inc si                      ; 次のアドレスにする
   277 00000129 E2F3                        loop .hex_loop              ; 16回繰り返し    
   278                                  
   279 0000012B 1F                          pop ds                      ; DSをモニタ用に戻す
   280                                  
   281 0000012C 8936[C504]                  mov [dump_off], si          ; DS復帰後に、SIの値をモニタ変数に保存
   282                                  
   283 00000130 E8F201                      call putc_crlf              ; 改行する
   284 00000133 59                          pop cx
   285 00000134 E2C5                        loop .line_loop             ; 4回繰り返す
   286                                      
   287 00000136 E91EFF                      jmp monitor_loop            ; モニタのメインルーチンに飛ぶ
   288                                  
   289                                  ; =================================================================
   290                                  ; Command: Load Intel HEX
   291                                  ; Usage:
   292                                  ;   L           -> Load to default segment (load_seg)
   293                                  ;   L <Seg>     -> Set segment and Load (e.g., L 2000)
   294                                  ; =================================================================
   295                                  do_load:
   296                                      ; 一時的に ES をロード先にするため、デフォルト値をAXへ退避
   297 00000139 A1[C704]                    mov ax, [load_seg]
   298 0000013C 06                          push es             ; RAM用ESを保存
   299 0000013D 50                          push ax             ; デフォルトセグメントを保存
   300                                      
   301 0000013E E8DB01                      call getc_echo
   302 00000141 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   303 00000143 7402                        je .parse_seg
   304 00000145 EB05                        jmp .start_load
   305                                  
   306                                  .parse_seg:
   307 00000147 58                          pop ax              ; 不要になったデフォルトを捨てる
   308 00000148 E80802                      call get_hex_word   ; 新しいセグメント取得
   309 0000014B 50                          push ax             ; 保存
   310                                  
   311                                  .start_load:
   312 0000014C E8D601                      call putc_crlf      ; メッセージ表示前に改行
   313 0000014F BE[D203]                    mov si, msg_load    ; ロード開始メッセージを表示
   314 00000152 E89701                      call puts
   315                                      
   316 00000155 58                          pop ax
   317 00000156 8EC0                        mov es, ax          ; ロード先をESに設定
   318                                      
   319                                      ; ターゲット表示
   320 00000158 E8D301                      call print_hex_word ; ESの値を表示
   321 0000015B B03A                        mov al, ':'         ; 区切り文字を表示
   322 0000015D E89A01                      call putc
   323 00000160 B030                        mov al, '0'         ; 本来は0000だが、0と簡易表示
   324 00000162 E89501                      call putc
   325 00000165 E8BD01                      call putc_crlf
   326                                  
   327                                  .wait_record:
   328 00000168 E8A201                      call getc           ; 開始文字を待つ
   329 0000016B 3C3A                        cmp al, ':'
   330 0000016D 75F9                        jne .wait_record
   331                                  
   332 0000016F E80602                      call get_hex_byte   ; データ長を読み込み
   333 00000172 88C1                        mov cl, al          ; データ長をcxレジスタに設定
   334 00000174 B500                        mov ch, 0
   335                                      
   336 00000176 E8FF01                      call get_hex_byte   ; 上位アドレスを読み込み
   337 00000179 88C7                        mov bh, al
   338 0000017B E8FA01                      call get_hex_byte   ; 下位アドレスを読み込み
   339 0000017E 88C3                        mov bl, al
   340                                      
   341 00000180 E8F501                      call get_hex_byte   ; レコードタイプを読み込み
   342 00000183 3C01                        cmp al, 01          ; End of File?
   343 00000185 7419                        je .handle_eof      ; EOFの処理へ
   344 00000187 3C00                        cmp al, 00          ; Data Record?
   345 00000189 751A                        jne .skip_line      ; その他はスキップ
   346                                      
   347 0000018B E309                        jcxz .read_chk      ; データ長がゼロならチェックサム読み込み処理
   348                                      
   349                                  .data_loop:
   350 0000018D E8E801                      call get_hex_byte   ; 1バイト読み取り
   351 00000190 268807                      mov [es:bx], al     ; ターゲット(ES)へ書き込み
   352 00000193 43                          inc bx              ; 次のアドレスにする
   353 00000194 E2F7                        loop .data_loop     ; データ長分繰り返す
   354                                      
   355                                  .read_chk:
   356 00000196 E8DF01                      call get_hex_byte   ; チェックサム読み取り（読み飛ばし）
   357 00000199 B02E                        mov al, '.'         ; 1行読んだことを示す"."を出力
   358 0000019B E85C01                      call putc
   359 0000019E EBC8                        jmp .wait_record    ; 次のレコード読み取りへ
   360                                  
   361                                  .handle_eof:            ; EOFの場合
   362 000001A0 E8D501                      call get_hex_byte   ; チェックサムを読み飛ばす
   363 000001A3 EB02                        jmp .finish         ; 読み込み終了処理へ
   364                                  
   365                                  .skip_line:
   366 000001A5 EBC1                        jmp .wait_record    ; 次のレコード読み込みへ
   367                                  
   368                                  .finish:
   369 000001A7 07                          pop es              ; RAM用ESを復帰
   370 000001A8 E87A01                      call putc_crlf
   371 000001AB BE[DE03]                    mov si, msg_ok      ; "OK"を表示
   372 000001AE E83B01                      call puts
   373 000001B1 E9A3FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   374                                  
   375                                  ; =================================================================
   376                                  ; Command: Execute
   377                                  ; Usage:
   378                                  ;   G <Seg> <Off>
   379                                  ; Example: G 1000 0000
   380                                  ; =================================================================
   381                                  do_go:
   382                                      ; Gコマンドは入力後に改行
   383                                      
   384 000001B4 E86501                      call getc_echo      ; Space?
   385 000001B7 3C20                        cmp al, ' '
   386 000001B9 751F                        jne .go_default     ; 引数なしならリターン(またはエラー)
   387                                      
   388                                      ; 1. セグメント (SSSS) を取得
   389 000001BB E89501                      call get_hex_word   ; AX = Segment
   390 000001BE 50                          push ax             ; スタックに積む (あとでRETFでCSになる)
   391 000001BF 89C3                        mov bx, ax          ; DS/ES用のために保存しておく
   392                                      
   393                                      ; スペース読み飛ばし (もしあれば)
   394 000001C1 E8D501                      call skip_space
   395                                      
   396                                      ; 2. オフセット (OOOO) を取得
   397 000001C4 E88C01                      call get_hex_word   ; AX = Offset
   398 000001C7 50                          push ax             ; スタックに積む (あとでRETFでIPになる)
   399                                      
   400 000001C8 E85A01                      call putc_crlf      ; 実行前に改行
   401 000001CB BE[E103]                    mov si, msg_go
   402 000001CE E81B01                      call puts
   403 000001D1 E85101                      call putc_crlf
   404                                      
   405                                      ; 3. 実行環境のセットアップ
   406                                      ; ジャンプ先のプログラムのために、DS, ES もセグメントに合わせておくのが親切
   407 000001D4 8EDB                        mov ds, bx
   408 000001D6 8EC3                        mov es, bx
   409                                  
   410                                      ; 必要なら割り込み禁止 (OSが自分でセットアップするまで黙らせる)
   411 000001D8 FA                          cli
   412                                  
   413                                      ; 4. ジャンプ！ (Far Return)
   414                                      ; スタック上の [IP, CS] をポップして、そこへ飛ぶ
   415 000001D9 CB                          retf                ; Jump!
   416                                  
   417                                  .go_default:
   418 000001DA E84801                      call putc_crlf      ; 改行して
   419 000001DD E977FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   420                                  
   421                                  ; ==============================================================
   422                                  ; Command: Write Memory
   423                                  ; Usage:
   424                                  ;   W <Seg> <Off> <Val>
   425                                  ; ==============================================================
   426                                  do_write:    
   427 000001E0 E83901                      call getc_echo      ; Space?
   428 000001E3 3C20                        cmp al, ' '
   429 000001E5 7403E9B301                  jne error           ; 引数なしならリターン(またはエラー)
   430                                  
   431                                      ; 1. セグメント (SSSS) を取得
   432 000001EA E86601                      call get_hex_word   ; AX = Segment
   433 000001ED 50                          push ax             ; ターゲットセグメントを保存
   434                                      
   435 000001EE E82B01                      call getc_echo      ; Space?
   436 000001F1 3C20                        cmp al, ' '
   437 000001F3 7403E9A501                  jne error           ; 引数なしならリターン(またはエラー)
   438                                      
   439                                      ; 2. オフセット (OOOO) を取得
   440 000001F8 E85801                      call get_hex_word   ; AX = Offset
   441 000001FB 50                          push ax             ; ターゲットオフセットを保存
   442                                  
   443 000001FC E81D01                      call getc_echo      ; Space?
   444 000001FF 3C20                        cmp al, ' '
   445 00000201 7403E99701                  jne error           ; 引数なしならリターン(またはエラー)
   446                                  
   447                                      ; 3. 設定データ (VV) を取得
   448 00000206 E85901                      call get_hex_byte_echo   ; AL = Value
   449                                  
   450 00000209 5B                          pop bx              ; bx = Offset
   451 0000020A 5A                          pop dx              ; dx = Target Segment
   452                                  
   453                                      ; 次回のDコマンドのためにダンプ位置変数を更新する
   454 0000020B 8916[C304]                  mov [dump_seg], dx
   455 0000020F 891E[C504]                  mov [dump_off], bx
   456                                      
   457 00000213 8EDA                        mov ds, dx          ; DS再設定
   458 00000215 3E8807                      mov [ds:bx], al     ; 書き込み！
   459                                      
   460 00000218 0E                          push cs             ; DSを復帰 (CS=DS前提のモニタなので)
   461 00000219 1F                          pop ds
   462                                  
   463 0000021A BE[0404]                    mov si, msg_done
   464 0000021D E8CC00                      call puts
   465 00000220 E934FE                      jmp monitor_loop
   466                                  
   467                                  ; ==============================================================
   468                                  ; Command: Input from Port
   469                                  ; Usage:
   470                                  ;   I <Port>
   471                                  ; ==============================================================
   472                                  do_in:
   473 00000223 E8F600                      call getc_echo
   474 00000226 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   475 00000228 7403E97001                  jne error           ; パラメタが無い場合はエラー処理へ
   476                                  
   477 0000022D E82301                      call get_hex_word   ; ポートアドレスを取得
   478 00000230 89C2                        mov dx, ax          ; 保存
   479 00000232 EC                          in al, dx           ; I/O Read
   480                                      
   481 00000233 50                          push ax
   482 00000234 E8EE00                      call putc_crlf      ; メッセージ表示前に改行
   483 00000237 BE[FE03]                    mov si, msg_in_res
   484 0000023A E8AF00                      call puts
   485 0000023D 58                          pop ax
   486                                  
   487 0000023E E8F400                      call print_hex_byte ; 値を表示
   488                                  
   489 00000241 E8E100                      call putc_crlf      ; 改行して
   490 00000244 E910FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   491                                  
   492                                  ; ==============================================================
   493                                  ; Command: Output to Port
   494                                  ; Usage
   495                                  ;   O <Port> <Val>
   496                                  ; ==============================================================
   497                                  do_out:
   498 00000247 E8D200                      call getc_echo
   499 0000024A 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   500 0000024C 7403E94C01                  jne error           ; パラメタが無い場合はエラー処理へ
   501                                  
   502 00000251 E8FF00                      call get_hex_word   ; ポートアドレスを取得
   503 00000254 50                          push ax             ; スタックに積む
   504                                  
   505 00000255 E8C400                      call getc_echo
   506 00000258 3C20                        cmp al, ' '         ; スペースがあれば第2パラメタがあると判断
   507 0000025A 750E                        jne error_pop       ; 第2パラメタが無い場合はエラー処理へ
   508                                      
   509 0000025C E80301                      call get_hex_byte_echo   ; 出力値を取得
   510 0000025F 5A                          pop dx              ; スタックからDXにセット
   511                                      
   512 00000260 EE                          out dx, al          ; I/O Write
   513                                      
   514 00000261 BE[0404]                    mov si, msg_done    ; DONEを表示。改行付き。
   515 00000264 E88500                      call puts
   516 00000267 E9EDFD                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   517                                  
   518                                  error_pop:
   519 0000026A 58                          pop ax              ; 使わなかったスタックを捨てる
   520 0000026B E92F01                      jmp error
   521                                  
   522                                  ; ==============================================================
   523                                  ; Command: Scan I/O Ports
   524                                  ; Usage:
   525                                  ;   S <Start_port> <End_port>
   526                                  ; Description: Reads ports and prints if value is NOT 0xFF
   527                                  ; ==============================================================
   528                                  do_scan:
   529 0000026E E8AB00                      call getc_echo
   530 00000271 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   531 00000273 7403E92501                  jne error           ; パラメタが無い場合はエラー処理へ
   532                                  
   533 00000278 E8D800                      call get_hex_word   ; スタートポートアドレスを取得
   534 0000027B 89C3                        mov bx, ax          ; BX = Start Address
   535                                      
   536 0000027D E89C00                      call getc_echo
   537 00000280 3C20                        cmp al, ' '         ; スペースがあれば第2パラメタがあると判断
   538 00000282 75E6                        jne error_pop       ; 第2パラメタが無い場合はエラー処理へ
   539                                  
   540 00000284 E8CC00                      call get_hex_word   ; エンドポートアドレスを取得
   541 00000287 89C1                        mov cx, ax          ; CX = End Address
   542                                  
   543 00000289 39CB                        cmp bx, cx          ; 開始 > 終了 ならエラー終了
   544 0000028B 7603E90D01                  ja error
   545                                  
   546 00000290 E89200                      call putc_crlf
   547 00000293 BE[8A04]                    mov si, msg_scan_start
   548 00000296 E85300                      call puts
   549                                  
   550                                  .scan_loop:
   551 00000299 89DA                        mov dx, bx          ; DXにポートアドレス設定
   552 0000029B EC                          in al, dx           ; I/O Read
   553                                  
   554 0000029C 3CFF                        cmp al, 0xFF        ; 0xFF (Empty Bus) なら表示しない
   555 0000029E 741D                        je .next_port
   556                                  
   557 000002A0 50                          push ax             ; Readした値をスタックに保存
   558                                  
   559                                      ; --- 有効な値が見つかった場合の表示 ---
   560                                      ; [Port]: Value
   561 000002A1 89D8                        mov ax, bx
   562 000002A3 E88800                      call print_hex_word ; ポートアドレスの表示
   563 000002A6 B03A                        mov al, ':'
   564 000002A8 E84F00                      call putc
   565 000002AB B020                        mov al, ' '
   566 000002AD E84A00                      call putc
   567                                      
   568 000002B0 58                          pop ax
   569 000002B1 E88100                      call print_hex_byte ; Readした値の表示
   570                                      
   571 000002B4 BE[B504]                    mov si, msg_space   ; "  "
   572 000002B7 E83200                      call puts
   573                                  
   574                                      ; 1行に見やすく並べるため、適当な間隔で改行を入れる等の工夫も可能ですが
   575                                      ; ここでは単純にリスト形式で改行します
   576 000002BA E86800                      call putc_crlf
   577                                  
   578                                  .next_port:
   579 000002BD 43                          inc bx              ; 次のアドレスへ
   580                                      
   581                                      ; キー入力チェック（長いスキャンを中断できるようにする）
   582 000002BE BA6112                      mov dx, SCU_SST
   583 000002C1 EC                          in al, dx
   584 000002C2 A802                        test al, RX_READY   ; RxRDY?
   585 000002C4 750D                        jnz .abort          ; 何かキーが押されたら中断
   586                                  
   587 000002C6 39CB                        cmp bx, cx
   588 000002C8 76CF                        jbe .scan_loop      ; BX <= CX ならループ
   589                                  
   590 000002CA BE[0404]                    mov si, msg_done
   591 000002CD E81C00                      call puts
   592 000002D0 E984FD                      jmp monitor_loop
   593                                  
   594                                  .abort:
   595                                      ; 入力バッファを空読みしておく
   596 000002D3 BA6012                      mov dx, SCU_DATA
   597 000002D6 EC                          in al, dx
   598 000002D7 BE[B804]                    mov si, msg_abort
   599 000002DA E80F00                      call puts
   600 000002DD E977FD                      jmp monitor_loop
   601                                  
   602                                  ; ==============================================================
   603                                  ; Command: Help
   604                                  ; ==============================================================
   605                                  cmd_help:
   606 000002E0 E84200                      call putc_crlf
   607 000002E3 BE[0F04]                    mov si, msg_help
   608 000002E6 E80300                      call puts
   609 000002E9 E96BFD                      jmp monitor_loop
   610                                  
   611                                  ; =================================================================
   612                                  ; Utilities
   613                                  ; =================================================================
   614                                  
   615                                  ; 文字列出力
   616                                  puts:
   617 000002EC 2E8A04                      mov al, [cs:si]
   618 000002EF 08C0                        or al, al
   619 000002F1 7406                        jz .ret
   620 000002F3 E80400                      call putc
   621 000002F6 46                          inc si
   622 000002F7 EBF3                        jmp puts
   623 000002F9 C3                      .ret: ret
   624                                  
   625                                  ; 1文字出力
   626                                  putc:
   627 000002FA 52                          push dx
   628 000002FB 50                          push ax
   629 000002FC BA6112                      mov dx, SCU_SST
   630 000002FF EC                      .w: in al, dx
   631 00000300 A801                        test al, TX_READY  ; TX Ready?
   632 00000302 74FB                        jz .w
   633 00000304 BA6012                      mov dx, SCU_DATA
   634 00000307 58                          pop ax
   635 00000308 50                          push ax
   636 00000309 EE                          out dx, al
   637 0000030A 58                          pop ax
   638 0000030B 5A                          pop dx
   639 0000030C C3                          ret
   640                                  
   641                                  ; 1文字入力
   642                                  getc:
   643 0000030D 52                          push dx
   644 0000030E BA6112                      mov dx, SCU_SST
   645 00000311 EC                      .w: in al, dx
   646 00000312 A802                        test al, RX_READY  ; RX Ready?
   647 00000314 74FB                        jz .w
   648 00000316 BA6012                      mov dx, SCU_DATA
   649 00000319 EC                          in al, dx
   650 0000031A 5A                          pop dx
   651 0000031B C3                          ret
   652                                  
   653                                  ; 1文字入力　エコーバックあり
   654                                  getc_echo:
   655 0000031C E8EEFF                      call getc
   656 0000031F 50                          push ax
   657 00000320 E8D7FF                      call putc
   658 00000323 58                          pop ax
   659 00000324 C3                          ret
   660                                  
   661                                  ; 改行出力
   662                                  putc_crlf:
   663 00000325 B00D                        mov al, 0x0D
   664 00000327 E8D0FF                      call putc
   665 0000032A B00A                        mov al, 0x0A
   666 0000032C EBCC                        jmp putc
   667                                  
   668                                  ; -----------------------------------------------------------------
   669                                  ; Helper: 1ワードを4文字のHEXで表示 (例: 0x2F3F -> "2", "F", "3", "F")
   670                                  ; Input: AX
   671                                  ; -----------------------------------------------------------------
   672                                  print_hex_word:
   673 0000032E 50                          push ax
   674 0000032F 88E0                        mov al, ah
   675 00000331 E80100                      call print_hex_byte
   676 00000334 58                          pop ax
   677                                  
   678                                  ; -----------------------------------------------------------------
   679                                  ; Helper: 1バイトを2文字のHEXで表示 (例: 0x3F -> "3", "F")
   680                                  ; Input: AL
   681                                  ; -----------------------------------------------------------------
   682                                  print_hex_byte:
   683 00000335 50                          push ax
   684 00000336 51                          push cx
   685                                  
   686                                      ; 上位バイトの表示
   687 00000337 50                          push ax
   688 00000338 C0E804                      shr al, 4
   689 0000033B E80900                      call .digit
   690                                  
   691                                      ; 下位バイトの表示
   692 0000033E 58                          pop ax
   693 0000033F 240F                        and al, 0x0F
   694 00000341 E80300                      call .digit
   695                                  
   696 00000344 59                          pop cx
   697 00000345 58                          pop ax
   698 00000346 C3                          ret
   699                                  
   700                                  ; 数値を16進数文字に変換して表示 (0-15 -> 0-9, A-F)
   701                                  .digit:
   702 00000347 0430                        add al, '0'
   703 00000349 3C39                        cmp al, '9'
   704 0000034B 7602                        jbe .p
   705 0000034D 0407                        add al, 7
   706 0000034F E8A8FF                  .p: call putc
   707 00000352 C3                          ret
   708                                  
   709                                  ; -----------------------------------------------------------------
   710                                  ; Helper: 4文字のHEXを受信して1ワード(16bit)の数値にする
   711                                  ; Input:  Serial (例: "1", "0", "0", "0")
   712                                  ; Output: AX = 0x1000
   713                                  ; -----------------------------------------------------------------
   714                                  get_hex_word:
   715 00000353 53                          push bx
   716 00000354 E80B00                      call get_hex_byte_echo
   717 00000357 88C7                        mov bh, al
   718 00000359 E80600                      call get_hex_byte_echo
   719 0000035C 88C3                        mov bl, al
   720 0000035E 89D8                        mov ax, bx
   721 00000360 5B                          pop bx
   722 00000361 C3                          ret
   723                                  
   724                                  ; 16進数2桁入力　エコーバック有り
   725                                  get_hex_byte_echo:
   726 00000362 53                          push bx
   727 00000363 E8B6FF                      call getc_echo
   728 00000366 E82500                      call hex_char_to_bin
   729 00000369 C0E004                      shl al, 4
   730 0000036C 88C3                        mov bl, al
   731 0000036E E8ABFF                      call getc_echo
   732 00000371 E81A00                      call hex_char_to_bin
   733 00000374 08D8                        or al, bl
   734 00000376 5B                          pop bx
   735 00000377 C3                          ret
   736                                  
   737                                  ; -----------------------------------------------------------------
   738                                  ; Helper: 2文字のHEXを受信して1バイトの数値にする
   739                                  ; Input:  Serial (例: "3", "F")
   740                                  ; Output: AL = 0x3F
   741                                  ; -----------------------------------------------------------------
   742                                  get_hex_byte:
   743 00000378 53                          push bx             ; BH/BLを使うので退避（メインでアドレス用に使ってるため重要）
   744                                  
   745                                      ; 上位4bit
   746 00000379 E891FF                      call getc
   747 0000037C E80F00                      call hex_char_to_bin
   748 0000037F C0E004                      shl al, 4
   749 00000382 88C3                        mov bl, al          ; 一時保存
   750                                      
   751                                      ; 下位4bit
   752 00000384 E886FF                      call getc
   753 00000387 E80400                      call hex_char_to_bin
   754 0000038A 08D8                        or al, bl           ; 上位を合成して結果はALへ
   755 0000038C 5B                          pop bx
   756 0000038D C3                          ret
   757                                  
   758                                  ; -----------------------------------------------------------------
   759                                  ; Helper: ASCII文字を数値へ (0-9, A-F -> 0-15)
   760                                  ; Input: AL (ASCII)
   761                                  ; Output: AL (Binary)
   762                                  ; -----------------------------------------------------------------
   763                                  hex_char_to_bin:
   764 0000038E 2C30                        sub al, '0'
   765 00000390 3C09                        cmp al, 9
   766 00000392 7604                        jbe .done
   767 00000394 2C07                        sub al, 7           ; 'A'-'F'対応
   768 00000396 240F                        and al, 0x0F        ; 小文字対応も含めてざっくりマスク
   769                                  .done:
   770 00000398 C3                          ret
   771                                  
   772                                  ; -----------------------------------------------------------------
   773                                  ; Helper: スペースなどを読み飛ばす
   774                                  ; -----------------------------------------------------------------
   775                                  skip_space:
   776 00000399 E880FF                      call getc_echo
   777 0000039C C3                          ret
   778                                  
   779                                  ; -----------------------------------------------------------------
   780                                  ; Helper: エラーメッセージ出力後モニタに戻る
   781                                  ; -----------------------------------------------------------------
   782                                  error:
   783 0000039D BE[E803]                    mov si, msg_error
   784 000003A0 E849FF                      call puts
   785 000003A3 E9B1FC                      jmp monitor_loop
   786                                  
   787                                  ; =================================================================
   788                                  ; Data
   789                                  ; =================================================================
   790 000003A6 0D0A2A2A2020563533-     msg_boot: db 0x0D,0x0A,"**  V53 RAM MONITOR v0.5 2026-01-24  **",0x0D,0x0A,0
   790 000003AF 2052414D204D4F4E49-
   790 000003B8 544F522076302E3520-
   790 000003C1 323032362D30312D32-
   790 000003CA 3420202A2A0D0A00   
   791 000003D2 4C6F6164204845582E-     msg_load: db "Load HEX...",0
   791 000003DB 2E2E00             
   792 000003DE 4F4B00                  msg_ok:   db "OK",0
   793 000003E1 476F2100                msg_go:   db "Go!",0
   794                                  
   795 000003E5 3E2000                  msg_prompt: db "> ", 0
   796 000003E8 4572726F720D0A00        msg_error:  db "Error", 0x0D, 0x0A, 0
   797 000003F0 556E6B6E6F776E2063-     msg_unknown:db "Unknown cmd", 0x0D, 0x0A, 0
   797 000003F9 6D640D0A00         
   798 000003FE 56616C3A2000            msg_in_res: db "Val: ", 0
   799 00000404 446F6E650D0A00          msg_done:   db "Done", 0x0D, 0x0A, 0
   800 0000040B 207C2000                msg_bar:    db " | ", 0
   801 0000040F 436D64733A2044203C-     msg_help:   db "Cmds: D <Seg> <Off>, L <Seg>, G <Seg> <Off>, W <Seg> <Off> <Val>, I <Port>, O <Port> <Val>, S <Start_port> <End_port>, ?", 0x0D, 0x0A, 0
   801 00000418 5365673E203C4F6666-
   801 00000421 3E2C204C203C536567-
   801 0000042A 3E2C2047203C536567-
   801 00000433 3E203C4F66663E2C20-
   801 0000043C 57203C5365673E203C-
   801 00000445 4F66663E203C56616C-
   801 0000044E 3E2C2049203C506F72-
   801 00000457 743E2C204F203C506F-
   801 00000460 72743E203C56616C3E-
   801 00000469 2C2053203C53746172-
   801 00000472 745F706F72743E203C-
   801 0000047B 456E645F706F72743E-
   801 00000484 2C203F0D0A00       
   802 0000048A 5363616E6E696E6720-     msg_scan_start: db "Scanning I/O (Press any key to abort)...", 0x0D, 0x0A, 0
   802 00000493 492F4F202850726573-
   802 0000049C 7320616E79206B6579-
   802 000004A5 20746F2061626F7274-
   802 000004AE 292E2E2E0D0A00     
   803 000004B5 202000                  msg_space:      db "  ", 0
   804 000004B8 41626F727465642E0D-     msg_abort:      db "Aborted.", 0x0D, 0x0A, 0
   804 000004C1 0A00               
   805                                  
   806                                  ; 変数
   807 000004C3 0000                    dump_seg:   dw  0x0000  ; Dump: セグメント保存用
   808 000004C5 0000                    dump_off:   dw  0x0000  ; Dump: オフセット保存用
   809 000004C7 0000                    load_seg:   dw  0x0000  ; Load: ターゲットセグメント
