     1                                  ; =================================================================
     2                                  ; V53 Monitor System v0.4  2026-01-21
     3                                  ; Target: V53 VME Board & DOSBox-X Simulation
     4                                  ; =================================================================
     5                                  
     6                                  ; --- ビルド方法 ---
     7                                  ; DOSBox: nasm -f bin -dSIM v53_ram_mon.asm -o v53_ram_mon.com -l v53_ram_mon.lst
     8                                  ; Real:   nasm -f bin v53_ram_mon.asm -o v53_ram_mon.bin -l v53_ram_mon.lst
     9                                  ; -----------------
    10                                  
    11                                  ; ==========================================
    12                                  ; V53 System Register
    13                                  ; ==========================================
    14                                  %define SCTL    0x0FFFE ; システム・コントロール・レジスタ
    15                                  %define OPSEL   0x0FFFD ; 内蔵ペリフェラル選択レジスタ
    16                                  %define OPHA    0x0FFFC ; 内蔵ペリフェラル・リロケーション・レジスタ
    17                                  %define DULA    0x0FFFB ; 
    18                                  %define IULA    0x0FFFA ; 
    19                                  %define TULA    0x0FFF9 ; 
    20                                  %define SULA    0x0FFF8 ; SCUリロケーション・レジスタ 
    21                                  %define WCY4    0x0FFF6 ; プログラマブル・ウェイト・サイクル数設定レジスタ4
    22                                  %define WCY3    0x0FFF5 ; プログラマブル・ウェイト・サイクル数設定レジスタ3
    23                                  %define WCY2    0x0FFF4 ; プログラマブル・ウェイト・サイクル数設定レジスタ2
    24                                  %define WMB1    0x0FFF3 ; プログラマブル・ウェイト・メモリ領域設定レジスタ1
    25                                  %define RFC     0x0FFF2 ; リフレッシュ・コントロール・レジスタ
    26                                  %define SBCR    0x0FFF1 ; 
    27                                  %define TCKS    0x0FFF0 ; 
    28                                  %define WAC     0x0FFED ; プログラマブル・ウェイト・メモリ・アドレス・コントロール・レジスタ
    29                                  %define WCY0    0x0FFEC ; プログラマブル・ウェイト・サイクル数設定レジスタ0
    30                                  %define WCY1    0x0FFEB ; プログラマブル・ウェイト・サイクル数設定レジスタ1
    31                                  %define WMB0    0x0FFEA ; プログラマブル・ウェイト・メモリ領域設定レジスタ0
    32                                  %define BRC     0x0FFE9 ; ボー・レート・カウンタ
    33                                  %define BADR    0x0FFE1 ; 
    34                                  %define BSEL    0x0FFE0 ; 
    35                                  %define XAM     0x0FF80 ; 
    36                                  %define PGR     0x0FF00 ; 
    37                                  
    38                                  
    39                                  
    40                                  %ifdef SIM
    41                                      ; --- Simulation Mode ---
    42                                      org 0x100
    43                                      cpu 186
    44                                  
    45                                      %define SCU_DATA   0x3F8
    46                                      %define SCU_SST    0x3FD
    47                                      %define TX_READY    0x20                                 
    48                                      %define RX_READY    0x01
    49                                  %else
    50                                      ; --- Real Hardware Mode ---
    51                                      org 0
    52                                      cpu 186
    53                                  
    54                                      ; SCUレジスタ (SCUは1260Hに仮配置）
    55                                      %define SCU_DATA    0x01260 ; 送受データ・レジスタ(R:SRB/W:STB)
    56                                      %define SCU_SST     0x01261 ; ステータス・レジスタ(R:SST)
    57                                      %define SCU_SCM     0x01261 ; コマンドレジスタ(W:SCM)
    58                                      %define SCU_SMD     0x01262 ; シリアルモード設定(W:SMD)
    59                                      %define SCU_SIMK    0x01263 ; シリアル割り込みマスクレジスタ(R/W:SIMK)
    60                                      %define TX_READY    00000001b   ; TBRDY                                 
    61                                      %define RX_READY    00000010b   ; RBRDY
    62                                  %endif
    63                                  
    64                                  section .text
    65                                  
    66                                  start:
    67                                  %ifdef SIM
    68                                      xor ax, ax
    69                                      mov es, ax
    70                                  %else
    71 00000000 FA                          cli
    72                                  
    73                                      ; ---------------------------------------------
    74                                      ; 1. セグメントレジスタ初期化
    75                                      ; CS=DS=ES を想定
    76                                      ; ---------------------------------------------
    77 00000001 0E                          push cs
    78 00000002 1F                          pop ds
    79 00000003 0E                          push cs
    80 00000004 07                          pop es
    81                                      ; スタックは簡易モニタのものをそのまま使う    
    82                                  %endif
    83                                  
    84                                      ; 変数初期化 (RAMエリアをクリア)
    85 00000005 C706[8904]0000              mov word [dump_seg], 0x0000
    86 0000000B C706[8B04]0000              mov word [dump_off], 0x0000
    87 00000011 C706[8D04]0020              mov word [load_seg], 0x2000
    88                                  
    89                                      ; スタートメッセージの表示
    90 00000017 BE[6C03]                    mov si, msg_boot
    91 0000001A E89502                      call puts
    92                                  
    93                                  ; =================================================================
    94                                  ; Main Loop
    95                                  ; =================================================================
    96                                  monitor_loop:
    97 0000001D B03E                        mov al, '>'
    98 0000001F E89E02                      call putc
    99 00000022 B020                        mov al, ' '
   100 00000024 E89902                      call putc
   101                                  
   102 00000027 E8B802                      call getc_echo  ; コマンド受信（エコーあり）
   103 0000002A 88C3                        mov bl, al
   104                                      
   105 0000002C 80FB64                      cmp bl, 'd'     ; dump command
   106 0000002F 746B                        je do_dump
   107 00000031 80FB44                      cmp bl, 'D'
   108 00000034 7466                        je do_dump
   109                                      
   110 00000036 80FB6C                      cmp bl, 'l'     ; load command
   111 00000039 7503E9C100                  je do_load
   112 0000003E 80FB4C                      cmp bl, 'L'
   113 00000041 7503E9B900                  je do_load
   114                                      
   115 00000046 80FB67                      cmp bl, 'g'     ; go command
   116 00000049 7503E92C01                  je do_go
   117 0000004E 80FB47                      cmp bl, 'G'
   118 00000051 7503E92401                  je do_go
   119                                  
   120 00000056 80FB77                      cmp bl, 'w'     ; Write command
   121 00000059 7503E94801                  je do_write
   122 0000005E 80FB57                      cmp bl, 'W'
   123 00000061 7503E94001                  je do_write
   124                                  
   125 00000066 3C69                        cmp al, 'i'     ; Input Port command
   126 00000068 7503E97C01                  je do_in
   127 0000006D 3C49                        cmp al, 'I'
   128 0000006F 7503E97501                  je do_in
   129                                  
   130 00000074 3C6F                        cmp al, 'o'     ; Output Port command
   131 00000076 7503E99201                  je do_out
   132 0000007B 3C4F                        cmp al, 'O'
   133 0000007D 7503E98B01                  je do_out
   134                                  
   135 00000082 3C73                        cmp al, 's'     ; Scan I/O command
   136 00000084 7503E9AB01                  je do_scan
   137 00000089 3C53                        cmp al, 'S'
   138 0000008B 7503E9A401                  je do_scan
   139                                      
   140 00000090 3C3F                        cmp al, '?'     ; Help
   141 00000092 7503E90F02                  je cmd_help
   142                                  
   143                                      ; 知らないコマンドなら改行して戻る
   144 00000097 E85102                      call putc_crlf
   145 0000009A EB81                        jmp monitor_loop
   146                                  
   147                                  ; =================================================================
   148                                  ; Command: Dump Memory
   149                                  ; Usage:
   150                                  ;   D               -> Dump next 64 bytes
   151                                  ;   D <Seg> <Off>   -> Set address and dump (e.g., D 0000 8000)
   152                                  ; =================================================================
   153                                  do_dump:
   154 0000009C E84302                      call getc_echo      ; 区切り文字受信 (Space or Enter)
   155 0000009F 3C0D                        cmp al, 0x0D        ; Enterならすぐ実行
   156 000000A1 7418                        je .dump_run
   157 000000A3 3C20                        cmp al, ' '         ; Spaceなら引数解析
   158 000000A5 7405                        je .parse_args
   159                                      
   160                                      ; それ以外なら無視して実行へ（またはエラー処理）
   161 000000A7 E84102                      call putc_crlf
   162 000000AA EB12                        jmp .dump_run_start
   163                                  
   164                                  .parse_args:
   165 000000AC E86A02                      call get_hex_word
   166 000000AF A3[8904]                    mov [dump_seg], ax
   167 000000B2 E8AA02                      call skip_space
   168 000000B5 E86102                      call get_hex_word
   169 000000B8 A3[8B04]                    mov [dump_off], ax
   170                                      ; ここでEnter待ちをするか、そのまま実行するか
   171                                      ; 今回はパラメータ入力後にEnterを押したと仮定して改行
   172                                      
   173                                  .dump_run:
   174 000000BB E82D02                      call putc_crlf              ; 実行直前に改行
   175                                  
   176                                  .dump_run_start:
   177 000000BE B90400                      mov cx, 4                   ; 4行表示する
   178                                      
   179                                  .line_loop:
   180 000000C1 51                          push cx
   181                                      
   182 000000C2 A1[8904]                    mov ax, [dump_seg]          ; セグメントの表示
   183 000000C5 E82C02                      call print_hex_word
   184 000000C8 B03A                        mov al, ':'                 ; 区切り文字の:を表示
   185 000000CA E8F301                      call putc
   186 000000CD A1[8B04]                    mov ax, [dump_off]          ; オフセットの表示
   187 000000D0 E82102                      call print_hex_word
   188 000000D3 B020                        mov al, ' '                 ; 区切り文字のスペースを表示
   189 000000D5 E8E801                      call putc
   190                                  
   191 000000D8 8B36[8B04]                  mov si, [dump_off]          ; DS変更前に、モニタ変数からオフセットをSIにロード
   192                                  
   193 000000DC 1E                          push ds                     ; モニタのDSを保存
   194 000000DD 8E1E[8904]                  mov ds, [dump_seg]          ; DSをターゲットセグメントに変更
   195                                      
   196 000000E1 B91000                      mov cx, 16                  ; 16回繰り返すカウンタ
   197                                  .hex_loop:
   198 000000E4 8A04                        mov al, [si]
   199 000000E6 E81202                      call print_hex_byte         ; メモリ内容の表示
   200 000000E9 B020                        mov al, ' '                 ; 区切り文字のスペースを表示
   201 000000EB E8D201                      call putc
   202 000000EE 46                          inc si                      ; 次のアドレスにする
   203 000000EF E2F3                        loop .hex_loop              ; 16回繰り返し    
   204                                  
   205 000000F1 1F                          pop ds                      ; DSをモニタ用に戻す
   206                                  
   207 000000F2 8936[8B04]                  mov [dump_off], si          ; DS復帰後に、SIの値をモニタ変数に保存
   208                                  
   209 000000F6 E8F201                      call putc_crlf              ; 改行する
   210 000000F9 59                          pop cx
   211 000000FA E2C5                        loop .line_loop             ; 4回繰り返す
   212                                      
   213 000000FC E91EFF                      jmp monitor_loop            ; モニタのメインルーチンに飛ぶ
   214                                  
   215                                  ; =================================================================
   216                                  ; Command: Load Intel HEX
   217                                  ; Usage:
   218                                  ;   L           -> Load to default segment (load_seg)
   219                                  ;   L <Seg>     -> Set segment and Load (e.g., L 2000)
   220                                  ; =================================================================
   221                                  do_load:
   222                                      ; 一時的に ES をロード先にするため、デフォルト値をAXへ退避
   223 000000FF A1[8D04]                    mov ax, [load_seg]
   224 00000102 06                          push es             ; RAM用ESを保存
   225 00000103 50                          push ax             ; デフォルトセグメントを保存
   226                                      
   227 00000104 E8DB01                      call getc_echo
   228 00000107 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   229 00000109 7402                        je .parse_seg
   230 0000010B EB05                        jmp .start_load
   231                                  
   232                                  .parse_seg:
   233 0000010D 58                          pop ax              ; 不要になったデフォルトを捨てる
   234 0000010E E80802                      call get_hex_word   ; 新しいセグメント取得
   235 00000111 50                          push ax             ; 保存
   236                                  
   237                                  .start_load:
   238 00000112 E8D601                      call putc_crlf      ; メッセージ表示前に改行
   239 00000115 BE[9803]                    mov si, msg_load    ; ロード開始メッセージを表示
   240 00000118 E89701                      call puts
   241                                      
   242 0000011B 58                          pop ax
   243 0000011C 8EC0                        mov es, ax          ; ロード先をESに設定
   244                                      
   245                                      ; ターゲット表示
   246 0000011E E8D301                      call print_hex_word ; ESの値を表示
   247 00000121 B03A                        mov al, ':'         ; 区切り文字を表示
   248 00000123 E89A01                      call putc
   249 00000126 B030                        mov al, '0'         ; 本来は0000だが、0と簡易表示
   250 00000128 E89501                      call putc
   251 0000012B E8BD01                      call putc_crlf
   252                                  
   253                                  .wait_record:
   254 0000012E E8A201                      call getc           ; 開始文字を待つ
   255 00000131 3C3A                        cmp al, ':'
   256 00000133 75F9                        jne .wait_record
   257                                  
   258 00000135 E80602                      call get_hex_byte   ; データ長を読み込み
   259 00000138 88C1                        mov cl, al          ; データ長をcxレジスタに設定
   260 0000013A B500                        mov ch, 0
   261                                      
   262 0000013C E8FF01                      call get_hex_byte   ; 上位アドレスを読み込み
   263 0000013F 88C7                        mov bh, al
   264 00000141 E8FA01                      call get_hex_byte   ; 下位アドレスを読み込み
   265 00000144 88C3                        mov bl, al
   266                                      
   267 00000146 E8F501                      call get_hex_byte   ; レコードタイプを読み込み
   268 00000149 3C01                        cmp al, 01          ; End of File?
   269 0000014B 7419                        je .handle_eof      ; EOFの処理へ
   270 0000014D 3C00                        cmp al, 00          ; Data Record?
   271 0000014F 751A                        jne .skip_line      ; その他はスキップ
   272                                      
   273 00000151 E309                        jcxz .read_chk      ; データ長がゼロならチェックサム読み込み処理
   274                                      
   275                                  .data_loop:
   276 00000153 E8E801                      call get_hex_byte   ; 1バイト読み取り
   277 00000156 268807                      mov [es:bx], al     ; ターゲット(ES)へ書き込み
   278 00000159 43                          inc bx              ; 次のアドレスにする
   279 0000015A E2F7                        loop .data_loop     ; データ長分繰り返す
   280                                      
   281                                  .read_chk:
   282 0000015C E8DF01                      call get_hex_byte   ; チェックサム読み取り（読み飛ばし）
   283 0000015F B02E                        mov al, '.'         ; 1行読んだことを示す"."を出力
   284 00000161 E85C01                      call putc
   285 00000164 EBC8                        jmp .wait_record    ; 次のレコード読み取りへ
   286                                  
   287                                  .handle_eof:            ; EOFの場合
   288 00000166 E8D501                      call get_hex_byte   ; チェックサムを読み飛ばす
   289 00000169 EB02                        jmp .finish         ; 読み込み終了処理へ
   290                                  
   291                                  .skip_line:
   292 0000016B EBC1                        jmp .wait_record    ; 次のレコード読み込みへ
   293                                  
   294                                  .finish:
   295 0000016D 07                          pop es              ; RAM用ESを復帰
   296 0000016E E87A01                      call putc_crlf
   297 00000171 BE[A403]                    mov si, msg_ok      ; "OK"を表示
   298 00000174 E83B01                      call puts
   299 00000177 E9A3FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   300                                  
   301                                  ; =================================================================
   302                                  ; Command: Execute
   303                                  ; Usage:
   304                                  ;   G <Seg> <Off>
   305                                  ; Example: G 1000 0000
   306                                  ; =================================================================
   307                                  do_go:
   308                                      ; Gコマンドは入力後に改行
   309                                      
   310 0000017A E86501                      call getc_echo      ; Space?
   311 0000017D 3C20                        cmp al, ' '
   312 0000017F 751F                        jne .go_default     ; 引数なしならリターン(またはエラー)
   313                                      
   314                                      ; 1. セグメント (SSSS) を取得
   315 00000181 E89501                      call get_hex_word   ; AX = Segment
   316 00000184 50                          push ax             ; スタックに積む (あとでRETFでCSになる)
   317 00000185 89C3                        mov bx, ax          ; DS/ES用のために保存しておく
   318                                      
   319                                      ; スペース読み飛ばし (もしあれば)
   320 00000187 E8D501                      call skip_space
   321                                      
   322                                      ; 2. オフセット (OOOO) を取得
   323 0000018A E88C01                      call get_hex_word   ; AX = Offset
   324 0000018D 50                          push ax             ; スタックに積む (あとでRETFでIPになる)
   325                                      
   326 0000018E E85A01                      call putc_crlf      ; 実行前に改行
   327 00000191 BE[A703]                    mov si, msg_go
   328 00000194 E81B01                      call puts
   329 00000197 E85101                      call putc_crlf
   330                                      
   331                                      ; 3. 実行環境のセットアップ
   332                                      ; ジャンプ先のプログラムのために、DS, ES もセグメントに合わせておくのが親切
   333 0000019A 8EDB                        mov ds, bx
   334 0000019C 8EC3                        mov es, bx
   335                                  
   336                                      ; 必要なら割り込み禁止 (OSが自分でセットアップするまで黙らせる)
   337 0000019E FA                          cli
   338                                  
   339                                      ; 4. ジャンプ！ (Far Return)
   340                                      ; スタック上の [IP, CS] をポップして、そこへ飛ぶ
   341 0000019F CB                          retf                ; Jump!
   342                                  
   343                                  .go_default:
   344 000001A0 E84801                      call putc_crlf      ; 改行して
   345 000001A3 E977FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   346                                  
   347                                  ; ==============================================================
   348                                  ; Command: Write Memory
   349                                  ; Usage:
   350                                  ;   W <Seg> <Off> <Val>
   351                                  ; ==============================================================
   352                                  do_write:    
   353 000001A6 E83901                      call getc_echo      ; Space?
   354 000001A9 3C20                        cmp al, ' '
   355 000001AB 7403E9B301                  jne error           ; 引数なしならリターン(またはエラー)
   356                                  
   357                                      ; 1. セグメント (SSSS) を取得
   358 000001B0 E86601                      call get_hex_word   ; AX = Segment
   359 000001B3 50                          push ax             ; ターゲットセグメントを保存
   360                                      
   361 000001B4 E82B01                      call getc_echo      ; Space?
   362 000001B7 3C20                        cmp al, ' '
   363 000001B9 7403E9A501                  jne error           ; 引数なしならリターン(またはエラー)
   364                                      
   365                                      ; 2. オフセット (OOOO) を取得
   366 000001BE E85801                      call get_hex_word   ; AX = Offset
   367 000001C1 50                          push ax             ; ターゲットオフセットを保存
   368                                  
   369 000001C2 E81D01                      call getc_echo      ; Space?
   370 000001C5 3C20                        cmp al, ' '
   371 000001C7 7403E99701                  jne error           ; 引数なしならリターン(またはエラー)
   372                                  
   373                                      ; 3. 設定データ (VV) を取得
   374 000001CC E85901                      call get_hex_byte_echo   ; AL = Value
   375                                  
   376 000001CF 5B                          pop bx              ; bx = Offset
   377 000001D0 5A                          pop dx              ; dx = Target Segment
   378                                  
   379                                      ; 次回のDコマンドのためにダンプ位置変数を更新する
   380 000001D1 8916[8904]                  mov [dump_seg], dx
   381 000001D5 891E[8B04]                  mov [dump_off], bx
   382                                      
   383 000001D9 8EDA                        mov ds, dx          ; DS再設定
   384 000001DB 3E8807                      mov [ds:bx], al     ; 書き込み！
   385                                      
   386 000001DE 0E                          push cs             ; DSを復帰 (CS=DS前提のモニタなので)
   387 000001DF 1F                          pop ds
   388                                  
   389 000001E0 BE[CA03]                    mov si, msg_done
   390 000001E3 E8CC00                      call puts
   391 000001E6 E934FE                      jmp monitor_loop
   392                                  
   393                                  ; ==============================================================
   394                                  ; Command: Input from Port
   395                                  ; Usage:
   396                                  ;   I <Port>
   397                                  ; ==============================================================
   398                                  do_in:
   399 000001E9 E8F600                      call getc_echo
   400 000001EC 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   401 000001EE 7403E97001                  jne error           ; パラメタが無い場合はエラー処理へ
   402                                  
   403 000001F3 E82301                      call get_hex_word   ; ポートアドレスを取得
   404 000001F6 89C2                        mov dx, ax          ; 保存
   405 000001F8 EC                          in al, dx           ; I/O Read
   406                                      
   407 000001F9 50                          push ax
   408 000001FA E8EE00                      call putc_crlf      ; メッセージ表示前に改行
   409 000001FD BE[C403]                    mov si, msg_in_res
   410 00000200 E8AF00                      call puts
   411 00000203 58                          pop ax
   412                                  
   413 00000204 E8F400                      call print_hex_byte ; 値を表示
   414                                  
   415 00000207 E8E100                      call putc_crlf      ; 改行して
   416 0000020A E910FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   417                                  
   418                                  ; ==============================================================
   419                                  ; Command: Output to Port
   420                                  ; Usage
   421                                  ;   O <Port> <Val>
   422                                  ; ==============================================================
   423                                  do_out:
   424 0000020D E8D200                      call getc_echo
   425 00000210 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   426 00000212 7403E94C01                  jne error           ; パラメタが無い場合はエラー処理へ
   427                                  
   428 00000217 E8FF00                      call get_hex_word   ; ポートアドレスを取得
   429 0000021A 50                          push ax             ; スタックに積む
   430                                  
   431 0000021B E8C400                      call getc_echo
   432 0000021E 3C20                        cmp al, ' '         ; スペースがあれば第2パラメタがあると判断
   433 00000220 750E                        jne error_pop       ; 第2パラメタが無い場合はエラー処理へ
   434                                      
   435 00000222 E80301                      call get_hex_byte_echo   ; 出力値を取得
   436 00000225 5A                          pop dx              ; スタックからDXにセット
   437                                      
   438 00000226 EE                          out dx, al          ; I/O Write
   439                                      
   440 00000227 BE[CA03]                    mov si, msg_done    ; DONEを表示。改行付き。
   441 0000022A E88500                      call puts
   442 0000022D E9EDFD                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   443                                  
   444                                  error_pop:
   445 00000230 58                          pop ax              ; 使わなかったスタックを捨てる
   446 00000231 E92F01                      jmp error
   447                                  
   448                                  ; ==============================================================
   449                                  ; Command: Scan I/O Ports
   450                                  ; Usage:
   451                                  ;   S <Start_port> <End_port>
   452                                  ; Description: Reads ports and prints if value is NOT 0xFF
   453                                  ; ==============================================================
   454                                  do_scan:
   455 00000234 E8AB00                      call getc_echo
   456 00000237 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   457 00000239 7403E92501                  jne error           ; パラメタが無い場合はエラー処理へ
   458                                  
   459 0000023E E8D800                      call get_hex_word   ; スタートポートアドレスを取得
   460 00000241 89C3                        mov bx, ax          ; BX = Start Address
   461                                      
   462 00000243 E89C00                      call getc_echo
   463 00000246 3C20                        cmp al, ' '         ; スペースがあれば第2パラメタがあると判断
   464 00000248 75E6                        jne error_pop       ; 第2パラメタが無い場合はエラー処理へ
   465                                  
   466 0000024A E8CC00                      call get_hex_word   ; エンドポートアドレスを取得
   467 0000024D 89C1                        mov cx, ax          ; CX = End Address
   468                                  
   469 0000024F 39CB                        cmp bx, cx          ; 開始 > 終了 ならエラー終了
   470 00000251 7603E90D01                  ja error
   471                                  
   472 00000256 E89200                      call putc_crlf
   473 00000259 BE[5004]                    mov si, msg_scan_start
   474 0000025C E85300                      call puts
   475                                  
   476                                  .scan_loop:
   477 0000025F 89DA                        mov dx, bx          ; DXにポートアドレス設定
   478 00000261 EC                          in al, dx           ; I/O Read
   479                                  
   480 00000262 3CFF                        cmp al, 0xFF        ; 0xFF (Empty Bus) なら表示しない
   481 00000264 741D                        je .next_port
   482                                  
   483 00000266 50                          push ax             ; Readした値をスタックに保存
   484                                  
   485                                      ; --- 有効な値が見つかった場合の表示 ---
   486                                      ; [Port]: Value
   487 00000267 89D8                        mov ax, bx
   488 00000269 E88800                      call print_hex_word ; ポートアドレスの表示
   489 0000026C B03A                        mov al, ':'
   490 0000026E E84F00                      call putc
   491 00000271 B020                        mov al, ' '
   492 00000273 E84A00                      call putc
   493                                      
   494 00000276 58                          pop ax
   495 00000277 E88100                      call print_hex_byte ; Readした値の表示
   496                                      
   497 0000027A BE[7B04]                    mov si, msg_space   ; "  "
   498 0000027D E83200                      call puts
   499                                  
   500                                      ; 1行に見やすく並べるため、適当な間隔で改行を入れる等の工夫も可能ですが
   501                                      ; ここでは単純にリスト形式で改行します
   502 00000280 E86800                      call putc_crlf
   503                                  
   504                                  .next_port:
   505 00000283 43                          inc bx              ; 次のアドレスへ
   506                                      
   507                                      ; キー入力チェック（長いスキャンを中断できるようにする）
   508 00000284 BA6112                      mov dx, SCU_SST
   509 00000287 EC                          in al, dx
   510 00000288 A802                        test al, RX_READY   ; RxRDY?
   511 0000028A 750D                        jnz .abort          ; 何かキーが押されたら中断
   512                                  
   513 0000028C 39CB                        cmp bx, cx
   514 0000028E 76CF                        jbe .scan_loop      ; BX <= CX ならループ
   515                                  
   516 00000290 BE[CA03]                    mov si, msg_done
   517 00000293 E81C00                      call puts
   518 00000296 E984FD                      jmp monitor_loop
   519                                  
   520                                  .abort:
   521                                      ; 入力バッファを空読みしておく
   522 00000299 BA6012                      mov dx, SCU_DATA
   523 0000029C EC                          in al, dx
   524 0000029D BE[7E04]                    mov si, msg_abort
   525 000002A0 E80F00                      call puts
   526 000002A3 E977FD                      jmp monitor_loop
   527                                  
   528                                  ; ==============================================================
   529                                  ; Command: Help
   530                                  ; ==============================================================
   531                                  cmd_help:
   532 000002A6 E84200                      call putc_crlf
   533 000002A9 BE[D503]                    mov si, msg_help
   534 000002AC E80300                      call puts
   535 000002AF E96BFD                      jmp monitor_loop
   536                                  
   537                                  ; =================================================================
   538                                  ; Utilities
   539                                  ; =================================================================
   540                                  
   541                                  ; 文字列出力
   542                                  puts:
   543 000002B2 2E8A04                      mov al, [cs:si]
   544 000002B5 08C0                        or al, al
   545 000002B7 7406                        jz .ret
   546 000002B9 E80400                      call putc
   547 000002BC 46                          inc si
   548 000002BD EBF3                        jmp puts
   549 000002BF C3                      .ret: ret
   550                                  
   551                                  ; 1文字出力
   552                                  putc:
   553 000002C0 52                          push dx
   554 000002C1 50                          push ax
   555 000002C2 BA6112                      mov dx, SCU_SST
   556 000002C5 EC                      .w: in al, dx
   557 000002C6 A801                        test al, TX_READY  ; TX Ready?
   558 000002C8 74FB                        jz .w
   559 000002CA BA6012                      mov dx, SCU_DATA
   560 000002CD 58                          pop ax
   561 000002CE 50                          push ax
   562 000002CF EE                          out dx, al
   563 000002D0 58                          pop ax
   564 000002D1 5A                          pop dx
   565 000002D2 C3                          ret
   566                                  
   567                                  ; 1文字入力
   568                                  getc:
   569 000002D3 52                          push dx
   570 000002D4 BA6112                      mov dx, SCU_SST
   571 000002D7 EC                      .w: in al, dx
   572 000002D8 A802                        test al, RX_READY  ; RX Ready?
   573 000002DA 74FB                        jz .w
   574 000002DC BA6012                      mov dx, SCU_DATA
   575 000002DF EC                          in al, dx
   576 000002E0 5A                          pop dx
   577 000002E1 C3                          ret
   578                                  
   579                                  ; 1文字入力　エコーバックあり
   580                                  getc_echo:
   581 000002E2 E8EEFF                      call getc
   582 000002E5 50                          push ax
   583 000002E6 E8D7FF                      call putc
   584 000002E9 58                          pop ax
   585 000002EA C3                          ret
   586                                  
   587                                  ; 改行出力
   588                                  putc_crlf:
   589 000002EB B00D                        mov al, 0x0D
   590 000002ED E8D0FF                      call putc
   591 000002F0 B00A                        mov al, 0x0A
   592 000002F2 EBCC                        jmp putc
   593                                  
   594                                  ; -----------------------------------------------------------------
   595                                  ; Helper: 1ワードを4文字のHEXで表示 (例: 0x2F3F -> "2", "F", "3", "F")
   596                                  ; Input: AX
   597                                  ; -----------------------------------------------------------------
   598                                  print_hex_word:
   599 000002F4 50                          push ax
   600 000002F5 88E0                        mov al, ah
   601 000002F7 E80100                      call print_hex_byte
   602 000002FA 58                          pop ax
   603                                  
   604                                  ; -----------------------------------------------------------------
   605                                  ; Helper: 1バイトを2文字のHEXで表示 (例: 0x3F -> "3", "F")
   606                                  ; Input: AL
   607                                  ; -----------------------------------------------------------------
   608                                  print_hex_byte:
   609 000002FB 50                          push ax
   610 000002FC 51                          push cx
   611                                  
   612                                      ; 上位バイトの表示
   613 000002FD 50                          push ax
   614 000002FE C0E804                      shr al, 4
   615 00000301 E80900                      call .digit
   616                                  
   617                                      ; 下位バイトの表示
   618 00000304 58                          pop ax
   619 00000305 240F                        and al, 0x0F
   620 00000307 E80300                      call .digit
   621                                  
   622 0000030A 59                          pop cx
   623 0000030B 58                          pop ax
   624 0000030C C3                          ret
   625                                  
   626                                  ; 数値を16進数文字に変換して表示 (0-15 -> 0-9, A-F)
   627                                  .digit:
   628 0000030D 0430                        add al, '0'
   629 0000030F 3C39                        cmp al, '9'
   630 00000311 7602                        jbe .p
   631 00000313 0407                        add al, 7
   632 00000315 E8A8FF                  .p: call putc
   633 00000318 C3                          ret
   634                                  
   635                                  ; -----------------------------------------------------------------
   636                                  ; Helper: 4文字のHEXを受信して1ワード(16bit)の数値にする
   637                                  ; Input:  Serial (例: "1", "0", "0", "0")
   638                                  ; Output: AX = 0x1000
   639                                  ; -----------------------------------------------------------------
   640                                  get_hex_word:
   641 00000319 53                          push bx
   642 0000031A E80B00                      call get_hex_byte_echo
   643 0000031D 88C7                        mov bh, al
   644 0000031F E80600                      call get_hex_byte_echo
   645 00000322 88C3                        mov bl, al
   646 00000324 89D8                        mov ax, bx
   647 00000326 5B                          pop bx
   648 00000327 C3                          ret
   649                                  
   650                                  ; 16進数2桁入力　エコーバック有り
   651                                  get_hex_byte_echo:
   652 00000328 53                          push bx
   653 00000329 E8B6FF                      call getc_echo
   654 0000032C E82500                      call hex_char_to_bin
   655 0000032F C0E004                      shl al, 4
   656 00000332 88C3                        mov bl, al
   657 00000334 E8ABFF                      call getc_echo
   658 00000337 E81A00                      call hex_char_to_bin
   659 0000033A 08D8                        or al, bl
   660 0000033C 5B                          pop bx
   661 0000033D C3                          ret
   662                                  
   663                                  ; -----------------------------------------------------------------
   664                                  ; Helper: 2文字のHEXを受信して1バイトの数値にする
   665                                  ; Input:  Serial (例: "3", "F")
   666                                  ; Output: AL = 0x3F
   667                                  ; -----------------------------------------------------------------
   668                                  get_hex_byte:
   669 0000033E 53                          push bx             ; BH/BLを使うので退避（メインでアドレス用に使ってるため重要）
   670                                  
   671                                      ; 上位4bit
   672 0000033F E891FF                      call getc
   673 00000342 E80F00                      call hex_char_to_bin
   674 00000345 C0E004                      shl al, 4
   675 00000348 88C3                        mov bl, al          ; 一時保存
   676                                      
   677                                      ; 下位4bit
   678 0000034A E886FF                      call getc
   679 0000034D E80400                      call hex_char_to_bin
   680 00000350 08D8                        or al, bl           ; 上位を合成して結果はALへ
   681 00000352 5B                          pop bx
   682 00000353 C3                          ret
   683                                  
   684                                  ; -----------------------------------------------------------------
   685                                  ; Helper: ASCII文字を数値へ (0-9, A-F -> 0-15)
   686                                  ; Input: AL (ASCII)
   687                                  ; Output: AL (Binary)
   688                                  ; -----------------------------------------------------------------
   689                                  hex_char_to_bin:
   690 00000354 2C30                        sub al, '0'
   691 00000356 3C09                        cmp al, 9
   692 00000358 7604                        jbe .done
   693 0000035A 2C07                        sub al, 7           ; 'A'-'F'対応
   694 0000035C 240F                        and al, 0x0F        ; 小文字対応も含めてざっくりマスク
   695                                  .done:
   696 0000035E C3                          ret
   697                                  
   698                                  ; -----------------------------------------------------------------
   699                                  ; Helper: スペースなどを読み飛ばす
   700                                  ; -----------------------------------------------------------------
   701                                  skip_space:
   702 0000035F E880FF                      call getc_echo
   703 00000362 C3                          ret
   704                                  
   705                                  ; -----------------------------------------------------------------
   706                                  ; Helper: エラーメッセージ出力後モニタに戻る
   707                                  ; -----------------------------------------------------------------
   708                                  error:
   709 00000363 BE[AE03]                    mov si, msg_error
   710 00000366 E849FF                      call puts
   711 00000369 E9B1FC                      jmp monitor_loop
   712                                  
   713                                  ; =================================================================
   714                                  ; Data
   715                                  ; =================================================================
   716 0000036C 0D0A2A2A2020563533-     msg_boot: db 0x0D,0x0A,"**  V53 RAM MONITOR v0.4 2026-01-21  **",0x0D,0x0A,0
   716 00000375 2052414D204D4F4E49-
   716 0000037E 544F522076302E3420-
   716 00000387 323032362D30312D32-
   716 00000390 3120202A2A0D0A00   
   717 00000398 4C6F6164204845582E-     msg_load: db "Load HEX...",0
   717 000003A1 2E2E00             
   718 000003A4 4F4B00                  msg_ok:   db "OK",0
   719 000003A7 476F2100                msg_go:   db "Go!",0
   720                                  
   721 000003AB 3E2000                  msg_prompt: db "> ", 0
   722 000003AE 4572726F720D0A00        msg_error:  db "Error", 0x0D, 0x0A, 0
   723 000003B6 556E6B6E6F776E2063-     msg_unknown:db "Unknown cmd", 0x0D, 0x0A, 0
   723 000003BF 6D640D0A00         
   724 000003C4 56616C3A2000            msg_in_res: db "Val: ", 0
   725 000003CA 446F6E650D0A00          msg_done:   db "Done", 0x0D, 0x0A, 0
   726 000003D1 207C2000                msg_bar:    db " | ", 0
   727 000003D5 436D64733A2044203C-     msg_help:   db "Cmds: D <Seg> <Off>, L <Seg>, G <Seg> <Off>, W <Seg> <Off> <Val>, I <Port>, O <Port> <Val>, S <Start_port> <End_port>, ?", 0x0D, 0x0A, 0
   727 000003DE 5365673E203C4F6666-
   727 000003E7 3E2C204C203C536567-
   727 000003F0 3E2C2047203C536567-
   727 000003F9 3E203C4F66663E2C20-
   727 00000402 57203C5365673E203C-
   727 0000040B 4F66663E203C56616C-
   727 00000414 3E2C2049203C506F72-
   727 0000041D 743E2C204F203C506F-
   727 00000426 72743E203C56616C3E-
   727 0000042F 2C2053203C53746172-
   727 00000438 745F706F72743E203C-
   727 00000441 456E645F706F72743E-
   727 0000044A 2C203F0D0A00       
   728 00000450 5363616E6E696E6720-     msg_scan_start: db "Scanning I/O (Press any key to abort)...", 0x0D, 0x0A, 0
   728 00000459 492F4F202850726573-
   728 00000462 7320616E79206B6579-
   728 0000046B 20746F2061626F7274-
   728 00000474 292E2E2E0D0A00     
   729 0000047B 202000                  msg_space:      db "  ", 0
   730 0000047E 41626F727465642E0D-     msg_abort:      db "Aborted.", 0x0D, 0x0A, 0
   730 00000487 0A00               
   731                                  
   732                                  ; 変数
   733 00000489 0000                    dump_seg:   dw  0x0000  ; Dump: セグメント保存用
   734 0000048B 0000                    dump_off:   dw  0x0000  ; Dump: オフセット保存用
   735 0000048D 0000                    load_seg:   dw  0x0000  ; Load: ターゲットセグメント
