     1                                  ; =================================================================
     2                                  ; V53 Monitor System v0.2  2026-01-18
     3                                  ; Target: V53 VME Board & DOSBox-X Simulation
     4                                  ; =================================================================
     5                                  
     6                                  ; --- ビルド方法 ---
     7                                  ; DOSBox: nasm -f bin -dSIM v53_ram_mon.asm -o v53_ram_mon.com -l v53_ram_mon.lst
     8                                  ; Real:   nasm -f bin v53_ram_mon.asm -o v53_ram_mon.bin -l v53_ram_mon.lst
     9                                  ; -----------------
    10                                  
    11                                  ; ==========================================
    12                                  ; V53 System Register
    13                                  ; ==========================================
    14                                  %define SCTL    0x0FFFE ; システム・コントロール・レジスタ
    15                                  %define OPSEL   0x0FFFD ; 内蔵ペリフェラル選択レジスタ
    16                                  %define OPHA    0x0FFFC ; 内蔵ペリフェラル・リロケーション・レジスタ
    17                                  %define DULA    0x0FFFB ; 
    18                                  %define IULA    0x0FFFA ; 
    19                                  %define TULA    0x0FFF9 ; 
    20                                  %define SULA    0x0FFF8 ; SCUリロケーション・レジスタ 
    21                                  %define WCY4    0x0FFF6 ; プログラマブル・ウェイト・サイクル数設定レジスタ4
    22                                  %define WCY3    0x0FFF5 ; プログラマブル・ウェイト・サイクル数設定レジスタ3
    23                                  %define WCY2    0x0FFF4 ; プログラマブル・ウェイト・サイクル数設定レジスタ2
    24                                  %define WMB1    0x0FFF3 ; プログラマブル・ウェイト・メモリ領域設定レジスタ1
    25                                  %define RFC     0x0FFF2 ; リフレッシュ・コントロール・レジスタ
    26                                  %define SBCR    0x0FFF1 ; 
    27                                  %define TCKS    0x0FFF0 ; 
    28                                  %define WAC     0x0FFED ; プログラマブル・ウェイト・メモリ・アドレス・コントロール・レジスタ
    29                                  %define WCY0    0x0FFEC ; プログラマブル・ウェイト・サイクル数設定レジスタ0
    30                                  %define WCY1    0x0FFEB ; プログラマブル・ウェイト・サイクル数設定レジスタ1
    31                                  %define WMB0    0x0FFEA ; プログラマブル・ウェイト・メモリ領域設定レジスタ0
    32                                  %define BRC     0x0FFE9 ; ボー・レート・カウンタ
    33                                  %define BADR    0x0FFE1 ; 
    34                                  %define BSEL    0x0FFE0 ; 
    35                                  %define XAM     0x0FF80 ; 
    36                                  %define PGR     0x0FF00 ; 
    37                                  
    38                                  
    39                                  
    40                                  %ifdef SIM
    41                                      ; --- Simulation Mode ---
    42                                      org 0x100
    43                                      cpu 186
    44                                  
    45                                      %define SCU_DATA   0x3F8
    46                                      %define SCU_SST    0x3FD
    47                                      %define TX_READY    0x20                                 
    48                                      %define RX_READY    0x01
    49                                  %else
    50                                      ; --- Real Hardware Mode ---
    51                                      org 0
    52                                      cpu 186
    53                                  
    54                                      ; SCUレジスタ (SCUは1260Hに仮配置）
    55                                      %define SCU_DATA    0x01260 ; 送受データ・レジスタ(R:SRB/W:STB)
    56                                      %define SCU_SST     0x01261 ; ステータス・レジスタ(R:SST)
    57                                      %define SCU_SCM     0x01261 ; コマンドレジスタ(W:SCM)
    58                                      %define SCU_SMD     0x01262 ; シリアルモード設定(W:SMD)
    59                                      %define SCU_SIMK    0x01263 ; シリアル割り込みマスクレジスタ(R/W:SIMK)
    60                                      %define TX_READY    00000001b   ; TBRDY                                 
    61                                      %define RX_READY    00000010b   ; RBRDY
    62                                  %endif
    63                                  
    64                                  section .text
    65                                  
    66                                  start:
    67                                  %ifdef SIM
    68                                      xor ax, ax
    69                                      mov es, ax
    70                                  %else
    71 00000000 FA                          cli
    72                                  
    73                                      ; ---------------------------------------------
    74                                      ; 1. セグメントレジスタ初期化
    75                                      ; CS=DS=ES を想定
    76                                      ; ---------------------------------------------
    77 00000001 0E                          push cs
    78 00000002 1F                          pop ds
    79 00000003 0E                          push cs
    80 00000004 07                          pop es
    81                                      ; スタックは簡易モニタのものをそのまま使う    
    82                                  %endif
    83                                  
    84                                      ; 変数初期化 (RAMエリアをクリア)
    85 00000005 C706[8A04]0000              mov word [dump_seg], 0x0000
    86 0000000B C706[8C04]0000              mov word [dump_off], 0x0000
    87 00000011 C706[8E04]0020              mov word [load_seg], 0x2000
    88                                  
    89                                      ; スタートメッセージの表示
    90 00000017 BE[6D03]                    mov si, msg_boot
    91 0000001A E89602                      call puts
    92                                  
    93                                  ; =================================================================
    94                                  ; Main Loop
    95                                  ; =================================================================
    96                                  monitor_loop:
    97 0000001D B03E                        mov al, '>'
    98 0000001F E89F02                      call putc
    99 00000022 B020                        mov al, ' '
   100 00000024 E89A02                      call putc
   101                                  
   102 00000027 E8B902                      call getc_echo  ; コマンド受信（エコーあり）
   103 0000002A 88C3                        mov bl, al
   104                                      
   105 0000002C 80FB64                      cmp bl, 'd'     ; dump command
   106 0000002F 746B                        je do_dump
   107 00000031 80FB44                      cmp bl, 'D'
   108 00000034 7466                        je do_dump
   109                                      
   110 00000036 80FB6C                      cmp bl, 'l'     ; load command
   111 00000039 7503E9C100                  je do_load
   112 0000003E 80FB4C                      cmp bl, 'L'
   113 00000041 7503E9B900                  je do_load
   114                                      
   115 00000046 80FB67                      cmp bl, 'g'     ; go command
   116 00000049 7503E92C01                  je do_go
   117 0000004E 80FB47                      cmp bl, 'G'
   118 00000051 7503E92401                  je do_go
   119                                  
   120 00000056 80FB77                      cmp bl, 'w'     ; Write command
   121 00000059 7503E94801                  je do_write
   122 0000005E 80FB57                      cmp bl, 'W'
   123 00000061 7503E94001                  je do_write
   124                                  
   125 00000066 3C69                        cmp al, 'i'     ; Input Port command
   126 00000068 7503E97C01                  je do_in
   127 0000006D 3C49                        cmp al, 'I'
   128 0000006F 7503E97501                  je do_in
   129                                  
   130 00000074 3C6F                        cmp al, 'o'     ; Output Port command
   131 00000076 7503E99201                  je do_out
   132 0000007B 3C4F                        cmp al, 'O'
   133 0000007D 7503E98B01                  je do_out
   134                                  
   135 00000082 3C73                        cmp al, 's'     ; Scan I/O command
   136 00000084 7503E9AB01                  je do_scan
   137 00000089 3C53                        cmp al, 'S'
   138 0000008B 7503E9A401                  je do_scan
   139                                      
   140 00000090 3C3F                        cmp al, '?'     ; Help
   141 00000092 7503E91002                  je cmd_help
   142                                  
   143                                      ; 知らないコマンドなら改行して戻る
   144 00000097 E85202                      call putc_crlf
   145 0000009A EB81                        jmp monitor_loop
   146                                  
   147                                  ; =================================================================
   148                                  ; Command: Dump Memory
   149                                  ; Usage:
   150                                  ;   D               -> Dump next 64 bytes
   151                                  ;   D <Seg> <Off>   -> Set address and dump (e.g., D 0000 8000)
   152                                  ; =================================================================
   153                                  do_dump:
   154 0000009C E84402                      call getc_echo      ; 区切り文字受信 (Space or Enter)
   155 0000009F 3C0D                        cmp al, 0x0D        ; Enterならすぐ実行
   156 000000A1 7418                        je .dump_run
   157 000000A3 3C20                        cmp al, ' '         ; Spaceなら引数解析
   158 000000A5 7405                        je .parse_args
   159                                      
   160                                      ; それ以外なら無視して実行へ（またはエラー処理）
   161 000000A7 E84202                      call putc_crlf
   162 000000AA EB12                        jmp .dump_run_start
   163                                  
   164                                  .parse_args:
   165 000000AC E86B02                      call get_hex_word
   166 000000AF A3[8A04]                    mov [dump_seg], ax
   167 000000B2 E8AB02                      call skip_space
   168 000000B5 E86202                      call get_hex_word
   169 000000B8 A3[8C04]                    mov [dump_off], ax
   170                                      ; ここでEnter待ちをするか、そのまま実行するか
   171                                      ; 今回はパラメータ入力後にEnterを押したと仮定して改行
   172                                      
   173                                  .dump_run:
   174 000000BB E82E02                      call putc_crlf              ; 実行直前に改行
   175                                  
   176                                  .dump_run_start:
   177 000000BE B90400                      mov cx, 4                   ; 4行表示する
   178                                      
   179                                  .line_loop:
   180 000000C1 51                          push cx
   181                                      
   182 000000C2 A1[8A04]                    mov ax, [dump_seg]          ; セグメントの表示
   183 000000C5 E82D02                      call print_hex_word
   184 000000C8 B03A                        mov al, ':'                 ; 区切り文字の:を表示
   185 000000CA E8F401                      call putc
   186 000000CD A1[8C04]                    mov ax, [dump_off]          ; オフセットの表示
   187 000000D0 E82202                      call print_hex_word
   188 000000D3 B020                        mov al, ' '                 ; 区切り文字のスペースを表示
   189 000000D5 E8E901                      call putc
   190                                  
   191 000000D8 8B36[8C04]                  mov si, [dump_off]          ; DS変更前に、モニタ変数からオフセットをSIにロード
   192                                  
   193 000000DC 1E                          push ds                     ; モニタのDSを保存
   194 000000DD 8E1E[8A04]                  mov ds, [dump_seg]          ; DSをターゲットセグメントに変更
   195                                      
   196 000000E1 B91000                      mov cx, 16                  ; 16回繰り返すカウンタ
   197                                  .hex_loop:
   198 000000E4 8A04                        mov al, [si]
   199 000000E6 E81302                      call print_hex_byte         ; メモリ内容の表示
   200 000000E9 B020                        mov al, ' '                 ; 区切り文字のスペースを表示
   201 000000EB E8D301                      call putc
   202 000000EE 46                          inc si                      ; 次のアドレスにする
   203 000000EF E2F3                        loop .hex_loop              ; 16回繰り返し    
   204                                  
   205 000000F1 1F                          pop ds                      ; DSをモニタ用に戻す
   206                                  
   207 000000F2 8936[8C04]                  mov [dump_off], si          ; DS復帰後に、SIの値をモニタ変数に保存
   208                                  
   209 000000F6 E8F301                      call putc_crlf              ; 改行する
   210 000000F9 59                          pop cx
   211 000000FA E2C5                        loop .line_loop             ; 4回繰り返す
   212                                      
   213 000000FC E91EFF                      jmp monitor_loop            ; モニタのメインルーチンに飛ぶ
   214                                  
   215                                  ; =================================================================
   216                                  ; Command: Load Intel HEX
   217                                  ; Usage:
   218                                  ;   L           -> Load to default segment (load_seg)
   219                                  ;   L <Seg>     -> Set segment and Load (e.g., L 2000)
   220                                  ; =================================================================
   221                                  do_load:
   222                                      ; 一時的に ES をロード先にするため、デフォルト値をAXへ退避
   223 000000FF A1[8E04]                    mov ax, [load_seg]
   224 00000102 06                          push es             ; RAM用ESを保存
   225 00000103 50                          push ax             ; デフォルトセグメントを保存
   226                                      
   227 00000104 E8DC01                      call getc_echo
   228 00000107 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   229 00000109 7402                        je .parse_seg
   230 0000010B EB05                        jmp .start_load
   231                                  
   232                                  .parse_seg:
   233 0000010D 58                          pop ax              ; 不要になったデフォルトを捨てる
   234 0000010E E80902                      call get_hex_word   ; 新しいセグメント取得
   235 00000111 50                          push ax             ; 保存
   236                                  
   237                                  .start_load:
   238 00000112 E8D701                      call putc_crlf      ; メッセージ表示前に改行
   239 00000115 BE[9903]                    mov si, msg_load    ; ロード開始メッセージを表示
   240 00000118 E89801                      call puts
   241                                      
   242 0000011B 58                          pop ax
   243 0000011C 8EC0                        mov es, ax          ; ロード先をESに設定
   244                                      
   245                                      ; ターゲット表示
   246 0000011E E8D401                      call print_hex_word ; ESの値を表示
   247 00000121 B03A                        mov al, ':'         ; 区切り文字を表示
   248 00000123 E89B01                      call putc
   249 00000126 B030                        mov al, '0'         ; 本来は0000だが、0と簡易表示
   250 00000128 E89601                      call putc
   251 0000012B E8BE01                      call putc_crlf
   252                                  
   253                                  .wait_record:
   254 0000012E E8A301                      call getc           ; 開始文字を待つ
   255 00000131 3C3A                        cmp al, ':'
   256 00000133 75F9                        jne .wait_record
   257                                  
   258 00000135 E80702                      call get_hex_byte   ; データ長を読み込み
   259 00000138 88C1                        mov cl, al          ; データ長をcxレジスタに設定
   260 0000013A B500                        mov ch, 0
   261                                      
   262 0000013C E80002                      call get_hex_byte   ; 上位アドレスを読み込み
   263 0000013F 88C7                        mov bh, al
   264 00000141 E8FB01                      call get_hex_byte   ; 下位アドレスを読み込み
   265 00000144 88C3                        mov bl, al
   266                                      
   267 00000146 E8F601                      call get_hex_byte   ; レコードタイプを読み込み
   268 00000149 3C01                        cmp al, 01          ; End of File?
   269 0000014B 7419                        je .handle_eof      ; EOFの処理へ
   270 0000014D 3C00                        cmp al, 00          ; Data Record?
   271 0000014F 751A                        jne .skip_line      ; その他はスキップ
   272                                      
   273 00000151 E309                        jcxz .read_chk      ; データ長がゼロならチェックサム読み込み処理
   274                                      
   275                                  .data_loop:
   276 00000153 E8E901                      call get_hex_byte   ; 1バイト読み取り
   277 00000156 268807                      mov [es:bx], al     ; ターゲット(ES)へ書き込み
   278 00000159 43                          inc bx              ; 次のアドレスにする
   279 0000015A E2F7                        loop .data_loop     ; データ長分繰り返す
   280                                      
   281                                  .read_chk:
   282 0000015C E8E001                      call get_hex_byte   ; チェックサム読み取り（読み飛ばし）
   283 0000015F B02E                        mov al, '.'         ; 1行読んだことを示す"."を出力
   284 00000161 E85D01                      call putc
   285 00000164 EBC8                        jmp .wait_record    ; 次のレコード読み取りへ
   286                                  
   287                                  .handle_eof:            ; EOFの場合
   288 00000166 E8D601                      call get_hex_byte   ; チェックサムを読み飛ばす
   289 00000169 EB02                        jmp .finish         ; 読み込み終了処理へ
   290                                  
   291                                  .skip_line:
   292 0000016B EBC1                        jmp .wait_record    ; 次のレコード読み込みへ
   293                                  
   294                                  .finish:
   295 0000016D 07                          pop es              ; RAM用ESを復帰
   296 0000016E E87B01                      call putc_crlf
   297 00000171 BE[A503]                    mov si, msg_ok      ; "OK"を表示
   298 00000174 E83C01                      call puts
   299 00000177 E9A3FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   300                                  
   301                                  ; =================================================================
   302                                  ; Command: Execute
   303                                  ; Usage:
   304                                  ;   G <Seg> <Off>
   305                                  ; Example: G 1000 0000
   306                                  ; =================================================================
   307                                  do_go:
   308                                      ; Gコマンドは入力後に改行
   309                                      
   310 0000017A E86601                      call getc_echo      ; Space?
   311 0000017D 3C20                        cmp al, ' '
   312 0000017F 751F                        jne .go_default     ; 引数なしならリターン(またはエラー)
   313                                      
   314                                      ; 1. セグメント (SSSS) を取得
   315 00000181 E89601                      call get_hex_word   ; AX = Segment
   316 00000184 50                          push ax             ; スタックに積む (あとでRETFでCSになる)
   317 00000185 89C3                        mov bx, ax          ; DS/ES用のために保存しておく
   318                                      
   319                                      ; スペース読み飛ばし (もしあれば)
   320 00000187 E8D601                      call skip_space
   321                                      
   322                                      ; 2. オフセット (OOOO) を取得
   323 0000018A E88D01                      call get_hex_word   ; AX = Offset
   324 0000018D 50                          push ax             ; スタックに積む (あとでRETFでIPになる)
   325                                      
   326 0000018E E85B01                      call putc_crlf      ; 実行前に改行
   327 00000191 BE[A803]                    mov si, msg_go
   328 00000194 E81C01                      call puts
   329 00000197 E85201                      call putc_crlf
   330                                      
   331                                      ; 3. 実行環境のセットアップ
   332                                      ; ジャンプ先のプログラムのために、DS, ES もセグメントに合わせておくのが親切
   333 0000019A 8EDB                        mov ds, bx
   334 0000019C 8EC3                        mov es, bx
   335                                  
   336                                      ; 必要なら割り込み禁止 (OSが自分でセットアップするまで黙らせる)
   337 0000019E FA                          cli
   338                                  
   339                                      ; 4. ジャンプ！ (Far Return)
   340                                      ; スタック上の [IP, CS] をポップして、そこへ飛ぶ
   341 0000019F CB                          retf                ; Jump!
   342                                  
   343                                  .go_default:
   344 000001A0 E84901                      call putc_crlf      ; 改行して
   345 000001A3 E977FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   346                                  
   347                                  ; ==============================================================
   348                                  ; Command: Write Memory
   349                                  ; Usage:
   350                                  ;   W <Seg> <Off> <Val>
   351                                  ; ==============================================================
   352                                  do_write:    
   353 000001A6 E83A01                      call getc_echo      ; Space?
   354 000001A9 3C20                        cmp al, ' '
   355 000001AB 7403E9B401                  jne error           ; 引数なしならリターン(またはエラー)
   356                                  
   357                                      ; 1. セグメント (SSSS) を取得
   358 000001B0 E86701                      call get_hex_word   ; AX = Segment
   359 000001B3 50                          push ax             ; ターゲットセグメントを保存
   360                                      
   361 000001B4 E82C01                      call getc_echo      ; Space?
   362 000001B7 3C20                        cmp al, ' '
   363 000001B9 7403E9A601                  jne error           ; 引数なしならリターン(またはエラー)
   364                                      
   365                                      ; 2. オフセット (OOOO) を取得
   366 000001BE E85901                      call get_hex_word   ; AX = Offset
   367 000001C1 50                          push ax             ; ターゲットオフセットを保存
   368                                  
   369 000001C2 E81E01                      call getc_echo      ; Space?
   370 000001C5 3C20                        cmp al, ' '
   371 000001C7 7403E99801                  jne error           ; 引数なしならリターン(またはエラー)
   372                                  
   373                                      ; 3. 設定データ (VV) を取得
   374 000001CC E85A01                      call get_hex_byte_echo   ; AL = Value
   375                                  
   376 000001CF 5B                          pop bx              ; bx = Offset
   377 000001D0 5A                          pop dx              ; dx = Target Segment
   378                                  
   379                                      ; 次回のDコマンドのためにダンプ位置変数を更新する
   380 000001D1 8916[8A04]                  mov [dump_seg], dx
   381 000001D5 891E[8C04]                  mov [dump_off], bx
   382                                      
   383 000001D9 8EDA                        mov ds, dx          ; DS再設定
   384 000001DB 3E8807                      mov [ds:bx], al     ; 書き込み！
   385                                      
   386 000001DE 0E                          push cs             ; DSを復帰 (CS=DS前提のモニタなので)
   387 000001DF 1F                          pop ds
   388                                  
   389 000001E0 BE[CB03]                    mov si, msg_done
   390 000001E3 E8CD00                      call puts
   391 000001E6 E934FE                      jmp monitor_loop
   392                                  
   393                                  ; ==============================================================
   394                                  ; Command: Input from Port
   395                                  ; Usage:
   396                                  ;   I <Port>
   397                                  ; ==============================================================
   398                                  do_in:
   399 000001E9 E8F700                      call getc_echo
   400 000001EC 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   401 000001EE 7403E97101                  jne error           ; パラメタが無い場合はエラー処理へ
   402                                  
   403 000001F3 E82401                      call get_hex_word   ; ポートアドレスを取得
   404 000001F6 89C2                        mov dx, ax          ; 保存
   405 000001F8 EC                          in al, dx           ; I/O Read
   406                                      
   407 000001F9 50                          push ax
   408 000001FA E8EF00                      call putc_crlf      ; メッセージ表示前に改行
   409 000001FD BE[C503]                    mov si, msg_in_res
   410 00000200 E8B000                      call puts
   411 00000203 58                          pop ax
   412                                  
   413 00000204 E8F500                      call print_hex_byte ; 値を表示
   414                                  
   415 00000207 E8E200                      call putc_crlf      ; 改行して
   416 0000020A E910FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   417                                  
   418                                  ; ==============================================================
   419                                  ; Command: Output to Port
   420                                  ; Usage
   421                                  ;   O <Port> <Val>
   422                                  ; ==============================================================
   423                                  do_out:
   424 0000020D E8D300                      call getc_echo
   425 00000210 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   426 00000212 7403E94D01                  jne error           ; パラメタが無い場合はエラー処理へ
   427                                  
   428 00000217 E80001                      call get_hex_word   ; ポートアドレスを取得
   429 0000021A 50                          push ax             ; スタックに積む
   430                                  
   431 0000021B E8C500                      call getc_echo
   432 0000021E 3C20                        cmp al, ' '         ; スペースがあれば第2パラメタがあると判断
   433 00000220 750E                        jne error_pop       ; 第2パラメタが無い場合はエラー処理へ
   434                                      
   435 00000222 E81A01                      call get_hex_byte   ; 出力値を取得
   436 00000225 5A                          pop dx              ; スタックからDXにセット
   437                                      
   438 00000226 EE                          out dx, al          ; I/O Write
   439                                      
   440 00000227 BE[CB03]                    mov si, msg_done    ; DONEを表示。改行付き。
   441 0000022A E88600                      call puts
   442 0000022D E9EDFD                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   443                                  
   444                                  error_pop:
   445 00000230 58                          pop ax              ; 使わなかったスタックを捨てる
   446 00000231 E93001                      jmp error
   447                                  
   448                                  ; ==============================================================
   449                                  ; Command: Scan I/O Ports
   450                                  ; Usage:
   451                                  ;   S <Start_port> <End_port>
   452                                  ; Description: Reads ports and prints if value is NOT 0xFF
   453                                  ; ==============================================================
   454                                  do_scan:
   455 00000234 E8AC00                      call getc_echo
   456 00000237 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   457 00000239 7403E92601                  jne error           ; パラメタが無い場合はエラー処理へ
   458                                  
   459 0000023E E8D900                      call get_hex_word   ; スタートポートアドレスを取得
   460 00000241 89C3                        mov bx, ax          ; BX = Start Address
   461                                      
   462 00000243 E89D00                      call getc_echo
   463 00000246 3C20                        cmp al, ' '         ; スペースがあれば第2パラメタがあると判断
   464 00000248 75E6                        jne error_pop       ; 第2パラメタが無い場合はエラー処理へ
   465                                  
   466 0000024A E8CD00                      call get_hex_word   ; エンドポートアドレスを取得
   467 0000024D 89C1                        mov cx, ax          ; CX = End Address
   468                                  
   469 0000024F 39CB                        cmp bx, cx          ; 開始 > 終了 ならエラー終了
   470 00000251 7603E90E01                  ja error
   471                                  
   472 00000256 E89300                      call putc_crlf
   473 00000259 BE[5104]                    mov si, msg_scan_start
   474 0000025C E85400                      call puts
   475                                  
   476                                  .scan_loop:
   477 0000025F 89DA                        mov dx, bx          ; DXにポートアドレス設定
   478 00000261 EC                          in al, dx           ; I/O Read
   479                                  
   480 00000262 3CFF                        cmp al, 0xFF        ; 0xFF (Empty Bus) なら表示しない
   481 00000264 741E                        je .next_port
   482                                  
   483                                      ; --- 有効な値が見つかった場合の表示 ---
   484                                      ; [Port]: Value
   485 00000266 89D8                        mov ax, bx
   486 00000268 E88A00                      call print_hex_word ; ポートアドレスの表示
   487 0000026B B03A                        mov al, ':'
   488 0000026D E85100                      call putc
   489 00000270 B020                        mov al, ' '
   490 00000272 E84C00                      call putc
   491                                      
   492 00000275 89DA                        mov dx, bx
   493 00000277 EC                          in al, dx           ; 再度読み直して表示（副作用注意）
   494 00000278 E88100                      call print_hex_byte ; Value
   495                                      
   496 0000027B BE[7C04]                    mov si, msg_space   ; "  "
   497 0000027E E83200                      call puts
   498                                  
   499                                      ; 1行に見やすく並べるため、適当な間隔で改行を入れる等の工夫も可能ですが
   500                                      ; ここでは単純にリスト形式で改行します
   501 00000281 E86800                      call putc_crlf
   502                                  
   503                                  .next_port:
   504 00000284 43                          inc bx              ; 次のアドレスへ
   505                                      
   506                                      ; キー入力チェック（長いスキャンを中断できるようにする）
   507 00000285 BA6112                      mov dx, SCU_SST
   508 00000288 EC                          in al, dx
   509 00000289 A802                        test al, RX_READY   ; RxRDY?
   510 0000028B 750D                        jnz .abort          ; 何かキーが押されたら中断
   511                                  
   512 0000028D 39CB                        cmp bx, cx
   513 0000028F 76CE                        jbe .scan_loop      ; BX <= CX ならループ
   514                                  
   515 00000291 BE[CB03]                    mov si, msg_done
   516 00000294 E81C00                      call puts
   517 00000297 E983FD                      jmp monitor_loop
   518                                  
   519                                  .abort:
   520                                      ; 入力バッファを空読みしておく
   521 0000029A BA6012                      mov dx, SCU_DATA
   522 0000029D EC                          in al, dx
   523 0000029E BE[7F04]                    mov si, msg_abort
   524 000002A1 E80F00                      call puts
   525 000002A4 E976FD                      jmp monitor_loop
   526                                  
   527                                  ; ==============================================================
   528                                  ; Command: Help
   529                                  ; ==============================================================
   530                                  cmd_help:
   531 000002A7 E84200                      call putc_crlf
   532 000002AA BE[D603]                    mov si, msg_help
   533 000002AD E80300                      call puts
   534 000002B0 E96AFD                      jmp monitor_loop
   535                                  
   536                                  ; =================================================================
   537                                  ; Utilities
   538                                  ; =================================================================
   539                                  
   540                                  ; 文字列出力
   541                                  puts:
   542 000002B3 2E8A04                      mov al, [cs:si]
   543 000002B6 08C0                        or al, al
   544 000002B8 7406                        jz .ret
   545 000002BA E80400                      call putc
   546 000002BD 46                          inc si
   547 000002BE EBF3                        jmp puts
   548 000002C0 C3                      .ret: ret
   549                                  
   550                                  ; 1文字出力
   551                                  putc:
   552 000002C1 52                          push dx
   553 000002C2 50                          push ax
   554 000002C3 BA6112                      mov dx, SCU_SST
   555 000002C6 EC                      .w: in al, dx
   556 000002C7 A801                        test al, TX_READY  ; TX Ready?
   557 000002C9 74FB                        jz .w
   558 000002CB BA6012                      mov dx, SCU_DATA
   559 000002CE 58                          pop ax
   560 000002CF 50                          push ax
   561 000002D0 EE                          out dx, al
   562 000002D1 58                          pop ax
   563 000002D2 5A                          pop dx
   564 000002D3 C3                          ret
   565                                  
   566                                  ; 1文字入力
   567                                  getc:
   568 000002D4 52                          push dx
   569 000002D5 BA6112                      mov dx, SCU_SST
   570 000002D8 EC                      .w: in al, dx
   571 000002D9 A802                        test al, RX_READY  ; RX Ready?
   572 000002DB 74FB                        jz .w
   573 000002DD BA6012                      mov dx, SCU_DATA
   574 000002E0 EC                          in al, dx
   575 000002E1 5A                          pop dx
   576 000002E2 C3                          ret
   577                                  
   578                                  ; 1文字入力　エコーバックあり
   579                                  getc_echo:
   580 000002E3 E8EEFF                      call getc
   581 000002E6 50                          push ax
   582 000002E7 E8D7FF                      call putc
   583 000002EA 58                          pop ax
   584 000002EB C3                          ret
   585                                  
   586                                  ; 改行出力
   587                                  putc_crlf:
   588 000002EC B00D                        mov al, 0x0D
   589 000002EE E8D0FF                      call putc
   590 000002F1 B00A                        mov al, 0x0A
   591 000002F3 EBCC                        jmp putc
   592                                  
   593                                  ; -----------------------------------------------------------------
   594                                  ; Helper: 1ワードを4文字のHEXで表示 (例: 0x2F3F -> "2", "F", "3", "F")
   595                                  ; Input: AX
   596                                  ; -----------------------------------------------------------------
   597                                  print_hex_word:
   598 000002F5 50                          push ax
   599 000002F6 88E0                        mov al, ah
   600 000002F8 E80100                      call print_hex_byte
   601 000002FB 58                          pop ax
   602                                  
   603                                  ; -----------------------------------------------------------------
   604                                  ; Helper: 1バイトを2文字のHEXで表示 (例: 0x3F -> "3", "F")
   605                                  ; Input: AL
   606                                  ; -----------------------------------------------------------------
   607                                  print_hex_byte:
   608 000002FC 50                          push ax
   609 000002FD 51                          push cx
   610                                  
   611                                      ; 上位バイトの表示
   612 000002FE 50                          push ax
   613 000002FF C0E804                      shr al, 4
   614 00000302 E80900                      call .digit
   615                                  
   616                                      ; 下位バイトの表示
   617 00000305 58                          pop ax
   618 00000306 240F                        and al, 0x0F
   619 00000308 E80300                      call .digit
   620                                  
   621 0000030B 59                          pop cx
   622 0000030C 58                          pop ax
   623 0000030D C3                          ret
   624                                  
   625                                  ; 数値を16進数文字に変換して表示 (0-15 -> 0-9, A-F)
   626                                  .digit:
   627 0000030E 0430                        add al, '0'
   628 00000310 3C39                        cmp al, '9'
   629 00000312 7602                        jbe .p
   630 00000314 0407                        add al, 7
   631 00000316 E8A8FF                  .p: call putc
   632 00000319 C3                          ret
   633                                  
   634                                  ; -----------------------------------------------------------------
   635                                  ; Helper: 4文字のHEXを受信して1ワード(16bit)の数値にする
   636                                  ; Input:  Serial (例: "1", "0", "0", "0")
   637                                  ; Output: AX = 0x1000
   638                                  ; -----------------------------------------------------------------
   639                                  get_hex_word:
   640 0000031A 53                          push bx
   641 0000031B E80B00                      call get_hex_byte_echo
   642 0000031E 88C7                        mov bh, al
   643 00000320 E80600                      call get_hex_byte_echo
   644 00000323 88C3                        mov bl, al
   645 00000325 89D8                        mov ax, bx
   646 00000327 5B                          pop bx
   647 00000328 C3                          ret
   648                                  
   649                                  ; 16進数2桁入力　エコーバック有り
   650                                  get_hex_byte_echo:
   651 00000329 53                          push bx
   652 0000032A E8B6FF                      call getc_echo
   653 0000032D E82500                      call hex_char_to_bin
   654 00000330 C0E004                      shl al, 4
   655 00000333 88C3                        mov bl, al
   656 00000335 E8ABFF                      call getc_echo
   657 00000338 E81A00                      call hex_char_to_bin
   658 0000033B 08D8                        or al, bl
   659 0000033D 5B                          pop bx
   660 0000033E C3                          ret
   661                                  
   662                                  ; -----------------------------------------------------------------
   663                                  ; Helper: 2文字のHEXを受信して1バイトの数値にする
   664                                  ; Input:  Serial (例: "3", "F")
   665                                  ; Output: AL = 0x3F
   666                                  ; -----------------------------------------------------------------
   667                                  get_hex_byte:
   668 0000033F 53                          push bx             ; BH/BLを使うので退避（メインでアドレス用に使ってるため重要）
   669                                  
   670                                      ; 上位4bit
   671 00000340 E891FF                      call getc
   672 00000343 E80F00                      call hex_char_to_bin
   673 00000346 C0E004                      shl al, 4
   674 00000349 88C3                        mov bl, al          ; 一時保存
   675                                      
   676                                      ; 下位4bit
   677 0000034B E886FF                      call getc
   678 0000034E E80400                      call hex_char_to_bin
   679 00000351 08D8                        or al, bl           ; 上位を合成して結果はALへ
   680 00000353 5B                          pop bx
   681 00000354 C3                          ret
   682                                  
   683                                  ; -----------------------------------------------------------------
   684                                  ; Helper: ASCII文字を数値へ (0-9, A-F -> 0-15)
   685                                  ; Input: AL (ASCII)
   686                                  ; Output: AL (Binary)
   687                                  ; -----------------------------------------------------------------
   688                                  hex_char_to_bin:
   689 00000355 2C30                        sub al, '0'
   690 00000357 3C09                        cmp al, 9
   691 00000359 7604                        jbe .done
   692 0000035B 2C07                        sub al, 7           ; 'A'-'F'対応
   693 0000035D 240F                        and al, 0x0F        ; 小文字対応も含めてざっくりマスク
   694                                  .done:
   695 0000035F C3                          ret
   696                                  
   697                                  ; -----------------------------------------------------------------
   698                                  ; Helper: スペースなどを読み飛ばす
   699                                  ; -----------------------------------------------------------------
   700                                  skip_space:
   701 00000360 E880FF                      call getc_echo
   702 00000363 C3                          ret
   703                                  
   704                                  ; -----------------------------------------------------------------
   705                                  ; Helper: エラーメッセージ出力後モニタに戻る
   706                                  ; -----------------------------------------------------------------
   707                                  error:
   708 00000364 BE[AF03]                    mov si, msg_error
   709 00000367 E849FF                      call puts
   710 0000036A E9B0FC                      jmp monitor_loop
   711                                  
   712                                  ; =================================================================
   713                                  ; Data
   714                                  ; =================================================================
   715 0000036D 0D0A2A2A2020563533-     msg_boot: db 0x0D,0x0A,"**  V53 RAM MONITOR v0.2 2026-01-19  **",0x0D,0x0A,0
   715 00000376 2052414D204D4F4E49-
   715 0000037F 544F522076302E3220-
   715 00000388 323032362D30312D31-
   715 00000391 3920202A2A0D0A00   
   716 00000399 4C6F6164204845582E-     msg_load: db "Load HEX...",0
   716 000003A2 2E2E00             
   717 000003A5 4F4B00                  msg_ok:   db "OK",0
   718 000003A8 476F2100                msg_go:   db "Go!",0
   719                                  
   720 000003AC 3E2000                  msg_prompt: db "> ", 0
   721 000003AF 4572726F720D0A00        msg_error:  db "Error", 0x0D, 0x0A, 0
   722 000003B7 556E6B6E6F776E2063-     msg_unknown:db "Unknown cmd", 0x0D, 0x0A, 0
   722 000003C0 6D640D0A00         
   723 000003C5 56616C3A2000            msg_in_res: db "Val: ", 0
   724 000003CB 446F6E650D0A00          msg_done:   db "Done", 0x0D, 0x0A, 0
   725 000003D2 207C2000                msg_bar:    db " | ", 0
   726 000003D6 436D64733A2044203C-     msg_help:   db "Cmds: D <Seg> <Off>, L <Seg>, G <Seg> <Off>, W <Seg> <Off> <Val>, I <Port>, O <Port> <Val>, S <Start_port> <End_port>, ?", 0x0D, 0x0A, 0
   726 000003DF 5365673E203C4F6666-
   726 000003E8 3E2C204C203C536567-
   726 000003F1 3E2C2047203C536567-
   726 000003FA 3E203C4F66663E2C20-
   726 00000403 57203C5365673E203C-
   726 0000040C 4F66663E203C56616C-
   726 00000415 3E2C2049203C506F72-
   726 0000041E 743E2C204F203C506F-
   726 00000427 72743E203C56616C3E-
   726 00000430 2C2053203C53746172-
   726 00000439 745F706F72743E203C-
   726 00000442 456E645F706F72743E-
   726 0000044B 2C203F0D0A00       
   727 00000451 5363616E6E696E6720-     msg_scan_start: db "Scanning I/O (Press any key to abort)...", 0x0D, 0x0A, 0
   727 0000045A 492F4F202850726573-
   727 00000463 7320616E79206B6579-
   727 0000046C 20746F2061626F7274-
   727 00000475 292E2E2E0D0A00     
   728 0000047C 202000                  msg_space:      db "  ", 0
   729 0000047F 41626F727465642E0D-     msg_abort:      db "Aborted.", 0x0D, 0x0A, 0
   729 00000488 0A00               
   730                                  
   731                                  ; 変数
   732 0000048A 0000                    dump_seg:   dw  0x0000  ; Dump: セグメント保存用
   733 0000048C 0000                    dump_off:   dw  0x0000  ; Dump: オフセット保存用
   734 0000048E 0000                    load_seg:   dw  0x0000  ; Load: ターゲットセグメント
