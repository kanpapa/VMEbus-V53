     1                                  ; =================================================================
     2                                  ; V53 Monitor System v0.1  2026-01-12
     3                                  ; Target: V53 VME Board & DOSBox-X Simulation
     4                                  ; =================================================================
     5                                  
     6                                  ; --- ビルド方法 ---
     7                                  ; DOSBox: nasm -f bin -dSIM v53mon.asm -o v53mon.com -l v53mon.lst
     8                                  ; Real:   nasm -f bin v53mon.asm -o v53mon.bin -l v53mon.lst
     9                                  ; -----------------
    10                                  
    11                                  ; ▼▼▼ ROMサイズ設定 (ここを環境に合わせる) ▼▼▼
    12                                  %define ROM_SIZE_1024  0x20000  ; 27C010 (128KB)
    13                                  ; 使用するROMサイズを選択
    14                                  %define ROM_TOTAL     ROM_SIZE_1024
    15                                  ; ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
    16                                  
    17                                  ; ==========================================
    18                                  ; V53 System Register
    19                                  ; ==========================================
    20                                  %define SCTL    0x0FFFE ; システム・コントロール・レジスタ
    21                                  %define OPSEL   0x0FFFD ; 内蔵ペリフェラル選択レジスタ
    22                                  %define OPHA    0x0FFFC ; 内蔵ペリフェラル・リロケーション・レジスタ
    23                                  %define DULA    0x0FFFB ; 
    24                                  %define IULA    0x0FFFA ; 
    25                                  %define TULA    0x0FFF9 ; 
    26                                  %define SULA    0x0FFF8 ; SCUリロケーション・レジスタ 
    27                                  %define WCY4    0x0FFF6 ; プログラマブル・ウェイト・サイクル数設定レジスタ4
    28                                  %define WCY3    0x0FFF5 ; プログラマブル・ウェイト・サイクル数設定レジスタ3
    29                                  %define WCY2    0x0FFF4 ; プログラマブル・ウェイト・サイクル数設定レジスタ2
    30                                  %define WMB1    0x0FFF3 ; プログラマブル・ウェイト・メモリ領域設定レジスタ1
    31                                  %define RFC     0x0FFF2 ; リフレッシュ・コントロール・レジスタ
    32                                  %define SBCR    0x0FFF1 ; 
    33                                  %define TCKS    0x0FFF0 ; 
    34                                  %define WAC     0x0FFED ; プログラマブル・ウェイト・メモリ・アドレス・コントロール・レジスタ
    35                                  %define WCY0    0x0FFEC ; プログラマブル・ウェイト・サイクル数設定レジスタ0
    36                                  %define WCY1    0x0FFEB ; プログラマブル・ウェイト・サイクル数設定レジスタ1
    37                                  %define WMB0    0x0FFEA ; プログラマブル・ウェイト・メモリ領域設定レジスタ0
    38                                  %define BRC     0x0FFE9 ; ボー・レート・カウンタ
    39                                  %define BADR    0x0FFE1 ; 
    40                                  %define BSEL    0x0FFE0 ; 
    41                                  %define XAM     0x0FF80 ; 
    42                                  %define PGR     0x0FF00 ; 
    43                                  
    44                                  ; --- RAM上の変数マップ (ES=0x0000 を前提に使用) ---
    45                                  ; 0x0000-0x03FF は割り込みベクタ(IVT)なので避ける
    46                                  %define VAR_DUMP_SEG    0x0400  ; Dump: セグメント保存用
    47                                  %define VAR_DUMP_OFF    0x0402  ; Dump: オフセット保存用
    48                                  %define VAR_LOAD_SEG    0x0404  ; Load: ターゲットセグメント
    49                                  
    50                                  %ifdef SIM
    51                                      ; --- Simulation Mode ---
    52                                      org 0x100
    53                                      cpu 186
    54                                  
    55                                      %define SCU_DATA   0x3F8
    56                                      %define SCU_SST    0x3FD
    57                                      %define TX_READY    0x20                                 
    58                                      %define RX_READY    0x01
    59                                  %else
    60                                      ; --- Real Hardware Mode ---
    61                                      org 0
    62                                      cpu 186
    63                                  
    64                                      ; SCUレジスタ (SCUは1260Hに仮配置）
    65                                      %define SCU_DATA    0x01260 ; 送受データ・レジスタ(R:SRB/W:STB)
    66                                      %define SCU_SST     0x01261 ; ステータス・レジスタ(R:SST)
    67                                      %define SCU_SCM     0x01261 ; コマンドレジスタ(W:SCM)
    68                                      %define SCU_SMD     0x01262 ; シリアルモード設定(W:SMD)
    69                                      %define SCU_SIMK    0x01263 ; シリアル割り込みマスクレジスタ(R/W:SIMK)
    70                                      %define TX_READY    00000001b   ; TBRDY                                 
    71                                      %define RX_READY    00000010b   ; RBRDY
    72                                  %endif
    73                                  
    74                                  section .text
    75                                  
    76                                  start:
    77                                  %ifdef SIM
    78                                      xor ax, ax
    79                                      mov es, ax
    80                                  %else
    81 00000000 FA                          cli
    82                                  
    83                                      ; ---------------------------------------------
    84                                      ; 1. セグメントレジスタ初期化
    85                                      ; ---------------------------------------------
    86 00000001 B80000                      mov ax, 0x0000
    87 00000004 8ED8                        mov ds, ax
    88 00000006 8EC0                        mov es, ax    
    89 00000008 8ED0                        mov ss, ax
    90 0000000A BC0040                      mov sp, 0x4000
    91                                  
    92                                      ; ---------------------------------------------
    93                                      ; 1.1 リフレッシュ制御
    94                                      ; すべてSRAMなのでリフレッシュ禁止にする
    95                                      ; ---------------------------------------------
    96                                      ; リセット時の値
    97                                      ; リセット時　リフレッシュ許可/禁止：不定
    98                                      ; RFC x0-01000
    99 0000000D BAF2FF                      mov dx, RFC
   100 00000010 B000                        mov al, 0
   101 00000012 EE                          out dx, al
   102                                  
   103                                      ; ---------------------------------------------
   104                                      ; 1.2 メモリウェイト値の設定
   105                                      ; オンボードRAMは35nsなので0Waitで良さそう
   106                                      ; 拡張RAMボードは70nsなので途中1waitの領域も設定
   107                                      ; ROMは70nsなので2waitに、外部I/Oは不明のためとりあえず3waitで
   108                                      ; ---------------------------------------------
   109                                      ; リセット時の値
   110                                      ; WMB0  -111-111  16MBのメモリ空間の上位、下位で8MB
   111                                      ; WMB1  -111-111　1MBメモリ空間の上位、下位で512KB
   112                                      ; WCY0-WCY3 すべて7wait
   113                                      ;
   114 00000013 BAF3FF                      mov dx, WMB1
   115 00000016 B071                        mov al, 01110001b	; L=512KB(Onboard RAM) M=256KB(VME RAM?) H=256KB(Onboard ROM)
   116 00000018 EE                          out dx, al
   117                                  
   118 00000019 BAF4FF                      mov dx, WCY2
   119 0000001C B010                        mov al, 00010000b	; M=1wait L=0wait
   120 0000001E EE                          out dx, al
   121                                  
   122 0000001F BAF5FF                      mov dx, WCY3
   123 00000022 B032                        mov al, 00110010b	; IO=3wait H=2wait
   124 00000024 EE                          out dx, al
   125                                  
   126                                      ; ---------------------------------------------
   127                                      ; 2. システム・コントロール・レジスタ (SCTL) の設定
   128                                      ; ビット4 (SC) = 1 : 内蔵BRGを使用
   129                                      ; ビット0 (IOAG) = 1 : 8ビット・バウンダリ（連続配置）
   130                                      ; ---------------------------------------------
   131 00000025 BAFEFF                      mov dx, SCTL
   132 00000028 B011                        mov al, 00010001b
   133 0000002A EE                          out dx, al
   134                                  
   135                                      ; ---------------------------------------------
   136                                      ; 3. ボーレートジェネレータ (BRG) の設定
   137                                      ;  38400bps設定 (fx=16MHz, factor=x16)
   138                                      ;  16,000,000/(16×38400) ≈ 26
   139                                      ; ---------------------------------------------
   140 0000002B BAE9FF                      mov dx, BRC
   141 0000002E B01A                        mov al, 26
   142 00000030 EE                          out dx, al
   143                                  
   144                                      ; ---------------------------------------------
   145                                      ; 4. IOアドレスの設定 (0x1260にSCUを仮配置)
   146                                      ; OPHA (FFFCH) に 12H を設定 (ベースアドレス上位8ビット)
   147                                      ; SULA (FFF8H) に 60H を設定 (SCUのオフセット)
   148                                      ; ---------------------------------------------
   149 00000031 BAFCFF                      mov dx, OPHA
   150 00000034 B012                        mov al, 0x12    ; 上位アドレス
   151 00000036 EE                          out dx, al
   152                                  
   153 00000037 BAF8FF                      mov dx, SULA
   154 0000003A B060                        mov al, 0x60    ; 下位アドレス
   155 0000003C EE                          out dx, al
   156                                      
   157                                      ; ---------------------------------------------
   158                                      ; 5. 内蔵周辺選択レジスタ (OPSEL) でSCUを有効化
   159                                      ; ビット3 (SS) = 1 : SCUの使用を許可
   160                                      ; ---------------------------------------------
   161 0000003D BAFDFF                      mov dx, OPSEL
   162 00000040 B008                        mov al, 00001000b   ; Bit3 (SS): SCUの使用を許可
   163 00000042 EE                          out dx, al
   164                                  
   165                                      ; ---------------------------------------------
   166                                      ; 6. SCU内部レジスタの初期化 (配置した1260Hを使用)
   167                                      ; ---------------------------------------------
   168                                      ; 動作モード設定 SMDレジスタ
   169                                      ; Mode: 非同期, 8bit, パリティなし, 1ストップビット, x16クロック
   170                                      ; 01 00 11 10
   171 00000043 BA6212                      mov dx, SCU_SMD
   172 00000046 B04E                        mov al, 01001110b
   173 00000048 EE                          out dx, al
   174                                  
   175                                      ; コマンド設定  SCMレジスタ
   176                                      ; Cmd: 送受信イネーブル, エラーリセット, DTR/RTSアクティブ
   177                                      ; 00 0 1 0 1 0 1
   178 00000049 BA6112                      mov dx, SCU_SCM
   179 0000004C B015                        mov al, 00010101b   ; RTS/DTR ON, RX/TX Enabl
   180 0000004E EE                          out dx, al
   181                                  
   182                                      ; 割り込みはマスクする  SIMKレジスタ
   183 0000004F BA6312                      mov dx, SCU_SIMK
   184 00000052 B003                        mov al, 00000011b
   185 00000054 EE                          out dx, al
   186                                  %endif
   187                                  
   188                                      ; 変数初期化 (RAMエリアをクリア)
   189 00000055 26C70600040000              mov word [es:VAR_DUMP_SEG], 0x0000
   190 0000005C 26C70602040000              mov word [es:VAR_DUMP_OFF], 0x0000
   191 00000063 26C70604040020              mov word [es:VAR_LOAD_SEG], 0x2000
   192                                  
   193                                      ; スタートメッセージの表示
   194 0000006A BE[6E02]                    mov si, msg_boot
   195 0000006D E84D01                      call puts
   196                                  
   197                                  ; =================================================================
   198                                  ; Main Loop
   199                                  ; =================================================================
   200                                  monitor_loop:
   201 00000070 B03E                        mov al, '>'
   202 00000072 E85601                      call putc
   203 00000075 B020                        mov al, ' '
   204 00000077 E85101                      call putc
   205                                  
   206 0000007A E87001                      call getc_echo  ; コマンド受信（エコーあり）
   207 0000007D 88C3                        mov bl, al
   208                                      
   209 0000007F 80FB64                      cmp bl, 'd'     ; dump command
   210 00000082 7427                        je do_dump
   211 00000084 80FB44                      cmp bl, 'D'
   212 00000087 7422                        je do_dump
   213                                      
   214 00000089 80FB6C                      cmp bl, 'l'     ; load command
   215 0000008C 7503E98400                  je do_load
   216 00000091 80FB4C                      cmp bl, 'L'
   217 00000094 747F                        je do_load
   218                                      
   219 00000096 80FB67                      cmp bl, 'g'     ; go command
   220 00000099 7503E9F300                  je do_go
   221 0000009E 80FB47                      cmp bl, 'G'
   222 000000A1 7503E9EB00                  je do_go
   223                                  
   224                                      ; 知らないコマンドなら改行して戻る
   225 000000A6 E84D01                      call putc_crlf
   226 000000A9 EBC5                        jmp monitor_loop
   227                                  
   228                                  ; =================================================================
   229                                  ; Command: Dump Memory
   230                                  ; Usage:
   231                                  ;   D               -> Dump next 64 bytes
   232                                  ;   D <Seg> <Off>   -> Set address and dump (e.g., D 0000 8000)
   233                                  ; =================================================================
   234                                  do_dump:
   235 000000AB E83F01                      call getc_echo      ; 区切り文字受信 (Space or Enter)
   236 000000AE 3C0D                        cmp al, 0x0D        ; Enterならすぐ実行
   237 000000B0 741A                        je .dump_run
   238 000000B2 3C20                        cmp al, ' '         ; Spaceなら引数解析
   239 000000B4 7405                        je .parse_args
   240                                      
   241                                      ; それ以外なら無視して実行へ（またはエラー処理）
   242 000000B6 E83D01                      call putc_crlf
   243 000000B9 EB14                        jmp .dump_run_start
   244                                  
   245                                  .parse_args:
   246 000000BB E86601                      call get_hex_word
   247 000000BE 26A30004                    mov [es:VAR_DUMP_SEG], ax
   248 000000C2 E8A501                      call skip_space
   249 000000C5 E85C01                      call get_hex_word
   250 000000C8 26A30204                    mov [es:VAR_DUMP_OFF], ax
   251                                      ; ここでEnter待ちをするか、そのまま実行するか
   252                                      ; 今回はパラメータ入力後にEnterを押したと仮定して改行
   253                                      
   254                                  .dump_run:
   255 000000CC E82701                      call putc_crlf              ; 実行直前に改行
   256                                  
   257                                  .dump_run_start:
   258 000000CF B90400                      mov cx, 4                   ; 4行表示する
   259                                      
   260                                  .line_loop:
   261 000000D2 51                          push cx
   262                                      
   263 000000D3 26A10004                    mov ax, [es:VAR_DUMP_SEG]   ; セグメントの表示
   264 000000D7 E82501                      call print_hex_word
   265 000000DA B03A                        mov al, ':'                 ; 区切り文字の:を表示
   266 000000DC E8EC00                      call putc
   267 000000DF 26A10204                    mov ax, [es:VAR_DUMP_OFF]   ; オフセットの表示
   268 000000E3 E81901                      call print_hex_word
   269 000000E6 B020                        mov al, ' '                 ; 区切り文字のスペースを表示
   270 000000E8 E8E000                      call putc
   271                                      
   272 000000EB 1E                          push ds
   273 000000EC 268E1E0004                  mov ds, [es:VAR_DUMP_SEG]
   274 000000F1 268B360204                  mov si, [es:VAR_DUMP_OFF]
   275                                      
   276 000000F6 B91000                      mov cx, 16                  ; 16回繰り返すカウンタ
   277                                  .hex_loop:
   278 000000F9 8A04                        mov al, [si]
   279 000000FB E80801                      call print_hex_byte         ; メモリ内容の表示
   280 000000FE B020                        mov al, ' '                 ; 区切り文字のスペースを表示
   281 00000100 E8C800                      call putc
   282 00000103 46                          inc si                      ; 次のアドレスにする
   283 00000104 E2F3                        loop .hex_loop              ; 16回繰り返し
   284                                      
   285 00000106 2689360204                  mov [es:VAR_DUMP_OFF], si   ; オフセットを更新
   286                                      
   287 0000010B 1F                          pop ds
   288 0000010C E8E700                      call putc_crlf              ; 改行する
   289 0000010F 59                          pop cx
   290 00000110 E2C0                        loop .line_loop             ; 4回繰り返す
   291                                      
   292 00000112 E95BFF                      jmp monitor_loop            ; モニタのメインルーチンに飛ぶ
   293                                  
   294                                  ; =================================================================
   295                                  ; Command: Load Intel HEX
   296                                  ; Usage:
   297                                  ;   L           -> Load to default segment (load_seg)
   298                                  ;   L <Seg>     -> Set segment and Load (e.g., L 2000)
   299                                  ; =================================================================
   300                                  do_load:
   301                                      ; 一時的に ES をロード先にするため、デフォルト値をAXへ退避
   302 00000115 26A10404                    mov ax, [es:VAR_LOAD_SEG]
   303 00000119 06                          push es             ; RAM用ESを保存
   304 0000011A 50                          push ax             ; デフォルトセグメントを保存
   305                                      
   306 0000011B E8CF00                      call getc_echo
   307 0000011E 3C20                        cmp al, ' '         ; スペースがあればパラメタ付きと判断
   308 00000120 7402                        je .parse_seg
   309 00000122 EB05                        jmp .start_load
   310                                  
   311                                  .parse_seg:
   312 00000124 58                          pop ax              ; 不要になったデフォルトを捨てる
   313 00000125 E8FC00                      call get_hex_word   ; 新しいセグメント取得
   314 00000128 50                          push ax             ; 保存
   315                                  
   316                                  .start_load:
   317 00000129 E8CA00                      call putc_crlf      ; メッセージ表示前に改行
   318 0000012C BE[9602]                    mov si, msg_load    ; ロード開始メッセージを表示
   319 0000012F E88B00                      call puts
   320                                      
   321 00000132 58                          pop ax
   322 00000133 8EC0                        mov es, ax          ; ロード先をESに設定
   323                                      
   324                                      ; ターゲット表示
   325 00000135 E8C700                      call print_hex_word ; ESの値を表示
   326 00000138 B03A                        mov al, ':'         ; 区切り文字を表示
   327 0000013A E88E00                      call putc
   328 0000013D B030                        mov al, '0'         ; 本来は0000だが、0と簡易表示
   329 0000013F E88900                      call putc
   330 00000142 E8B100                      call putc_crlf
   331                                  
   332                                  .wait_record:
   333 00000145 E89600                      call getc           ; 開始文字を待つ
   334 00000148 3C3A                        cmp al, ':'
   335 0000014A 75F9                        jne .wait_record
   336                                  
   337 0000014C E8FA00                      call get_hex_byte   ; データ長を読み込み
   338 0000014F 88C1                        mov cl, al          ; データ長をcxレジスタに設定
   339 00000151 B500                        mov ch, 0
   340                                      
   341 00000153 E8F300                      call get_hex_byte   ; 上位アドレスを読み込み
   342 00000156 88C7                        mov bh, al
   343 00000158 E8EE00                      call get_hex_byte   ; 下位アドレスを読み込み
   344 0000015B 88C3                        mov bl, al
   345                                      
   346 0000015D E8E900                      call get_hex_byte   ; レコードタイプを読み込み
   347 00000160 3C01                        cmp al, 01          ; End of File?
   348 00000162 7419                        je .handle_eof      ; EOFの処理へ
   349 00000164 3C00                        cmp al, 00          ; Data Record?
   350 00000166 751A                        jne .skip_line      ; その他はスキップ
   351                                      
   352 00000168 E309                        jcxz .read_chk      ; データ長がゼロならチェックサム読み込み処理
   353                                      
   354                                  .data_loop:
   355 0000016A E8DC00                      call get_hex_byte   ; 1バイト読み取り
   356 0000016D 268807                      mov [es:bx], al     ; ターゲット(ES)へ書き込み
   357 00000170 43                          inc bx              ; 次のアドレスにする
   358 00000171 E2F7                        loop .data_loop     ; データ長分繰り返す
   359                                      
   360                                  .read_chk:
   361 00000173 E8D300                      call get_hex_byte   ; チェックサム読み取り（読み飛ばし）
   362 00000176 B02E                        mov al, '.'         ; 1行読んだことを示す"."を出力
   363 00000178 E85000                      call putc
   364 0000017B EBC8                        jmp .wait_record    ; 次のレコード読み取りへ
   365                                  
   366                                  .handle_eof:            ; EOFの場合
   367 0000017D E8C900                      call get_hex_byte   ; チェックサムを読み飛ばす
   368 00000180 EB02                        jmp .finish         ; 読み込み終了処理へ
   369                                  
   370                                  .skip_line:
   371 00000182 EBC1                        jmp .wait_record    ; 次のレコード読み込みへ
   372                                  
   373                                  .finish:
   374 00000184 07                          pop es              ; RAM用ESを復帰
   375 00000185 E86E00                      call putc_crlf
   376 00000188 BE[A202]                    mov si, msg_ok      ; "OK"を表示
   377 0000018B E82F00                      call puts
   378 0000018E E9DFFE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   379                                  
   380                                  ; =================================================================
   381                                  ; Command: Go (Execute)
   382                                  ; Format: G <Segment> <Offset>
   383                                  ; Example: G 1000 0000
   384                                  ; =================================================================
   385                                  do_go:
   386                                      ; Gコマンドは入力後に改行
   387                                      
   388 00000191 E85900                      call getc_echo      ; Space?
   389 00000194 3C20                        cmp al, ' '
   390 00000196 751F                        jne .go_default     ; 引数なしならリターン(またはエラー)
   391                                      
   392                                      ; 1. セグメント (SSSS) を取得
   393 00000198 E88900                      call get_hex_word   ; AX = Segment
   394 0000019B 50                          push ax             ; スタックに積む (あとでRETFでCSになる)
   395 0000019C 89C3                        mov bx, ax          ; DS/ES用のために保存しておく
   396                                      
   397                                      ; スペース読み飛ばし (もしあれば)
   398 0000019E E8C900                      call skip_space
   399                                      
   400                                      ; 2. オフセット (OOOO) を取得
   401 000001A1 E88000                      call get_hex_word   ; AX = Offset
   402 000001A4 50                          push ax             ; スタックに積む (あとでRETFでIPになる)
   403                                      
   404 000001A5 E84E00                      call putc_crlf      ; 実行前に改行
   405 000001A8 BE[A502]                    mov si, msg_go
   406 000001AB E80F00                      call puts
   407 000001AE E84500                      call putc_crlf
   408                                      
   409                                      ; 3. 実行環境のセットアップ
   410                                      ; ジャンプ先のプログラムのために、DS, ES もセグメントに合わせておくのが親切
   411 000001B1 8EDB                        mov ds, bx
   412 000001B3 8EC3                        mov es, bx
   413                                  
   414                                      ; 必要なら割り込み禁止 (OSが自分でセットアップするまで黙らせる)
   415 000001B5 FA                          cli
   416                                  
   417                                      ; 4. ジャンプ！ (Far Return)
   418                                      ; スタック上の [IP, CS] をポップして、そこへ飛ぶ
   419 000001B6 CB                          retf                ; Jump!
   420                                  
   421                                  .go_default:
   422 000001B7 E83C00                      call putc_crlf      ; 改行して
   423 000001BA E9B3FE                      jmp monitor_loop    ; モニタのメインルーチンに飛ぶ
   424                                  
   425                                  ; =================================================================
   426                                  ; Utilities
   427                                  ; =================================================================
   428                                  
   429                                  ; 文字列出力
   430                                  puts:
   431 000001BD 2E8A04                      mov al, [cs:si]
   432 000001C0 08C0                        or al, al
   433 000001C2 7406                        jz .ret
   434 000001C4 E80400                      call putc
   435 000001C7 46                          inc si
   436 000001C8 EBF3                        jmp puts
   437 000001CA C3                      .ret: ret
   438                                  
   439                                  ; 1文字出力
   440                                  putc:
   441 000001CB 52                          push dx
   442 000001CC 50                          push ax
   443 000001CD BA6112                      mov dx, SCU_SST
   444 000001D0 EC                      .w: in al, dx
   445 000001D1 A801                        test al, TX_READY  ; TX Ready?
   446 000001D3 74FB                        jz .w
   447 000001D5 BA6012                      mov dx, SCU_DATA
   448 000001D8 58                          pop ax
   449 000001D9 50                          push ax
   450 000001DA EE                          out dx, al
   451 000001DB 58                          pop ax
   452 000001DC 5A                          pop dx
   453 000001DD C3                          ret
   454                                  
   455                                  ; 1文字入力
   456                                  getc:
   457 000001DE 52                          push dx
   458 000001DF BA6112                      mov dx, SCU_SST
   459 000001E2 EC                      .w: in al, dx
   460 000001E3 A802                        test al, RX_READY  ; RX Ready?
   461 000001E5 74FB                        jz .w
   462 000001E7 BA6012                      mov dx, SCU_DATA
   463 000001EA EC                          in al, dx
   464 000001EB 5A                          pop dx
   465 000001EC C3                          ret
   466                                  
   467                                  ; 1文字入力　エコーバックあり
   468                                  getc_echo:
   469 000001ED E8EEFF                      call getc
   470 000001F0 50                          push ax
   471 000001F1 E8D7FF                      call putc
   472 000001F4 58                          pop ax
   473 000001F5 C3                          ret
   474                                  
   475                                  ; 改行出力
   476                                  putc_crlf:
   477 000001F6 B00D                        mov al, 0x0D
   478 000001F8 E8D0FF                      call putc
   479 000001FB B00A                        mov al, 0x0A
   480 000001FD EBCC                        jmp putc
   481                                  
   482                                  ; -----------------------------------------------------------------
   483                                  ; Helper: 1ワードを4文字のHEXで表示 (例: 0x2F3F -> "2", "F", "3", "F")
   484                                  ; Input: AX
   485                                  ; -----------------------------------------------------------------
   486                                  print_hex_word:
   487 000001FF 50                          push ax
   488 00000200 88E0                        mov al, ah
   489 00000202 E80100                      call print_hex_byte
   490 00000205 58                          pop ax
   491                                  
   492                                  ; -----------------------------------------------------------------
   493                                  ; Helper: 1バイトを2文字のHEXで表示 (例: 0x3F -> "3", "F")
   494                                  ; Input: AL
   495                                  ; -----------------------------------------------------------------
   496                                  print_hex_byte:
   497 00000206 50                          push ax
   498 00000207 51                          push cx
   499                                  
   500                                      ; 上位バイトの表示
   501 00000208 50                          push ax
   502 00000209 C0E804                      shr al, 4
   503 0000020C E80900                      call .digit
   504                                  
   505                                      ; 下位バイトの表示
   506 0000020F 58                          pop ax
   507 00000210 240F                        and al, 0x0F
   508 00000212 E80300                      call .digit
   509                                  
   510 00000215 59                          pop cx
   511 00000216 58                          pop ax
   512 00000217 C3                          ret
   513                                  
   514                                  ; 数値を16進数文字に変換して表示 (0-15 -> 0-9, A-F)
   515                                  .digit:
   516 00000218 0430                        add al, '0'
   517 0000021A 3C39                        cmp al, '9'
   518 0000021C 7602                        jbe .p
   519 0000021E 0407                        add al, 7
   520 00000220 E8A8FF                  .p: call putc
   521 00000223 C3                          ret
   522                                  
   523                                  ; -----------------------------------------------------------------
   524                                  ; Helper: 4文字のHEXを受信して1ワード(16bit)の数値にする
   525                                  ; Input:  Serial (例: "1", "0", "0", "0")
   526                                  ; Output: AX = 0x1000
   527                                  ; -----------------------------------------------------------------
   528                                  get_hex_word:
   529 00000224 53                          push bx
   530 00000225 E80B00                      call get_hex_byte_echo
   531 00000228 88C7                        mov bh, al
   532 0000022A E80600                      call get_hex_byte_echo
   533 0000022D 88C3                        mov bl, al
   534 0000022F 89D8                        mov ax, bx
   535 00000231 5B                          pop bx
   536 00000232 C3                          ret
   537                                  
   538                                  ; 16進数2桁入力　エコーバック有り
   539                                  get_hex_byte_echo:
   540 00000233 53                          push bx
   541 00000234 E8B6FF                      call getc_echo
   542 00000237 E82500                      call hex_char_to_bin
   543 0000023A C0E004                      shl al, 4
   544 0000023D 88C3                        mov bl, al
   545 0000023F E8ABFF                      call getc_echo
   546 00000242 E81A00                      call hex_char_to_bin
   547 00000245 08D8                        or al, bl
   548 00000247 5B                          pop bx
   549 00000248 C3                          ret
   550                                  
   551                                  ; -----------------------------------------------------------------
   552                                  ; Helper: 2文字のHEXを受信して1バイトの数値にする
   553                                  ; Input:  Serial (例: "3", "F")
   554                                  ; Output: AL = 0x3F
   555                                  ; -----------------------------------------------------------------
   556                                  get_hex_byte:
   557 00000249 53                          push bx             ; BH/BLを使うので退避（メインでアドレス用に使ってるため重要）
   558                                  
   559                                      ; 上位4bit
   560 0000024A E891FF                      call getc
   561 0000024D E80F00                      call hex_char_to_bin
   562 00000250 C0E004                      shl al, 4
   563 00000253 88C3                        mov bl, al          ; 一時保存
   564                                      
   565                                      ; 下位4bit
   566 00000255 E886FF                      call getc
   567 00000258 E80400                      call hex_char_to_bin
   568 0000025B 08D8                        or al, bl           ; 上位を合成して結果はALへ
   569 0000025D 5B                          pop bx
   570 0000025E C3                          ret
   571                                  
   572                                  ; -----------------------------------------------------------------
   573                                  ; Helper: ASCII文字を数値へ (0-9, A-F -> 0-15)
   574                                  ; Input: AL (ASCII)
   575                                  ; Output: AL (Binary)
   576                                  ; -----------------------------------------------------------------
   577                                  hex_char_to_bin:
   578 0000025F 2C30                        sub al, '0'
   579 00000261 3C09                        cmp al, 9
   580 00000263 7604                        jbe .done
   581 00000265 2C07                        sub al, 7           ; 'A'-'F'対応
   582 00000267 240F                        and al, 0x0F        ; 小文字対応も含めてざっくりマスク
   583                                  .done:
   584 00000269 C3                          ret
   585                                  
   586                                  ; -----------------------------------------------------------------
   587                                  ; Helper: スペースなどを読み飛ばす
   588                                  ; -----------------------------------------------------------------
   589                                  skip_space:
   590 0000026A E880FF                      call getc_echo
   591 0000026D C3                          ret
   592                                  
   593                                  ; =================================================================
   594                                  ; Data
   595                                  ; =================================================================
   596 0000026E 0D0A2A2A2020563533-     msg_boot: db 0x0D,0x0A,"**  V53 MONITOR v0.1 2026-01-12  **",0x0D,0x0A,0
   596 00000277 204D4F4E49544F5220-
   596 00000280 76302E312032303236-
   596 00000289 2D30312D313220202A-
   596 00000292 2A0D0A00           
   597 00000296 4C6F6164204845582E-     msg_load: db "Load HEX...",0
   597 0000029F 2E2E00             
   598 000002A2 4F4B00                  msg_ok:   db "OK",0
   599 000002A5 476F2100                msg_go:   db "Go!",0
   600                                  
   601                                  %ifndef SIM
   602                                  ; -----------------------------------------------------------------
   603                                  ; Padding (空白埋め)
   604                                  ; コードの終わりから、リセットベクタの手前までを0xFFで埋める
   605                                  ; -----------------------------------------------------------------
   606 000002A9 FF<rep 1FD47h>              times ROM_TOTAL - 16 - ($ - $$) db 0xFF
   607                                  
   608                                  ; -----------------------------------------------------------------
   609                                  ; Reset Vector (Physical Address FFFF0h)
   610                                  ; CPUは電源ON時、ここ(ROMの末尾16バイト地点)を実行する
   611                                  ; -----------------------------------------------------------------
   612                                  reset_vector:
   613                                      ; ROMの先頭(start)へジャンプする
   614                                      ; 1MBit ROMの場合、物理アドレスは E0000h～FFFFFh にマップされる想定
   615                                      ; なので、セグメント E000h, オフセット 0000h へ飛べばよい
   616                                      
   617 0001FFF0 EA000000E0                  jmp 0xE000:0000   ; Far Jump to start of 128KB ROM
   618                                  
   619                                      ; ファイルサイズがぴったりROMサイズになるよう調整
   620 0001FFF5 FF<rep Bh>                  times 16 - ($ - reset_vector) db 0xFF
   621                                  %endif
